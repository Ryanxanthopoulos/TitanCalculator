<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fencing Quote Calculator</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font for a cleaner look */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #eef2f6; /* Lighter blue-gray background */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top to prevent vertical centering on very short content */
            min-height: 100vh; /* Ensure it takes at least full viewport height */
            padding: 2.5rem 1.5rem; /* Increased padding around the body */
            box-sizing: border-box; /* Include padding in element's total width and height */
        }
        .container {
            max-width: 900px;
            width: 100%; /* Ensure it takes full width on small screens */
            margin: 0 auto; /* Center horizontally */
            padding: 2.5rem; /* Increased padding inside the container */
            background-color: #ffffff;
            border-radius: 16px; /* More rounded corners */
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); /* Softer, larger shadow */
            box-sizing: border-box;
        }
        h1 {
            font-size: 2.5rem; /* Slightly larger heading */
            font-weight: 700;
            color: #1a202c; /* Darker text for headings */
            margin-bottom: 2.5rem; /* More space below heading */
        }
        .input-group {
            margin-bottom: 1.75rem; /* More space between input groups */
        }
        .input-group label {
            display: block;
            margin-bottom: 0.75rem; /* Slightly more space below label */
            font-weight: 600;
            color: #2d3748; /* Darker label text */
            font-size: 1rem; /* Standard label font size */
        }
        .input-group input[type="number"],
        .input-group select,
        .input-group input[type="text"] { /* Added text input */
            width: 100%;
            padding: 0.95rem 1.15rem; /* Increased padding for inputs */
            border: 1px solid #cbd5e0; /* Softer border color */
            border-radius: 12px; /* Slightly more rounded inputs */
            font-size: 1rem;
            color: #2d3748;
            background-color: #ffffff;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-group input[type="number"]:focus,
        .input-group select:focus,
        .input-group input[type="text"]:focus { /* Added text input focus */
            outline: none;
            border-color: #4299e1; /* Brighter blue on focus */
            box-shadow: 0 0 0 4px rgba(66, 153, 225, 0.3); /* Subtle blue glow */
        }
        /* Specific styling for inputs with symbols to adjust padding */
        .input-with-symbol-right {
            padding-right: 2.5rem !important; /* Extra padding for the symbol */
        }
        .input-with-symbol-left {
            padding-left: 2.5rem !important; /* Extra padding for the symbol */
        }

        .radio-group label {
            margin-right: 2.5rem; /* More space between radio options */
            font-weight: 500; /* Lighter font weight */
        }
        .radio-group input[type="radio"] {
            transform: scale(1.1); /* Slightly larger radio buttons */
        }

        .results-section {
            background-color: #f8fafc; /* Very light background for results */
            padding: 2.5rem; /* Increased padding */
            border-radius: 14px; /* More rounded corners */
            border: 1px solid #e2e8f0; /* Soft border */
            margin-top: 3rem; /* More space above results */
        }
        .results-section h2 {
            font-size: 2rem; /* Larger results heading */
            font-weight: 700;
            margin-bottom: 1.75rem;
            color: #2c5282; /* Deep blue for results heading */
        }
        /* Removed direct styling for h3 in results-section to allow toggle-btn to style it */
        .results-section .subtotal-line {
            font-weight: 600;
            text-align: right;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px dashed #e2e8f0; /* Softer dashed line */
            color: #2d3748;
            font-size: 1.05rem; /* Slightly larger font for subtotals */
        }
        .results-section .subtotal-line span {
            font-weight: 700;
        }
        .error-message {
            background-color: #ffeaea; /* Softer red background */
            color: #e53e3e; /* Brighter red text */
            padding: 1.5rem; /* More padding */
            border-radius: 12px;
            margin-bottom: 2rem;
            border: 1px solid #fbd3d3;
            font-weight: 500;
        }
        .message-box, .modal { /* Combined styling for message box and new modals */
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 2.5rem; /* More padding */
            border-radius: 16px; /* More rounded */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25); /* More prominent shadow */
            z-index: 1000;
            display: none;
            max-width: 450px; /* Slightly wider */
            text-align: center;
            border: 1px solid #e2e8f0;
            max-height: 80vh; /* Max height for scrollable content */
            overflow-y: auto; /* Enable scrolling for modal content */
        }
        .message-box h3, .modal h3 {
            font-size: 1.5rem; /* Larger message title */
            font-weight: 700;
            margin-bottom: 1rem;
            color: #1a202c;
        }
        .message-box p, .modal p {
            margin-bottom: 2rem; /* More space below message */
            color: #4a5568;
            line-height: 1.5;
        }
        .message-box button, .modal button {
            background-color: #4299e1; /* Tailwind blue-500 */
            color: white;
            padding: 0.8rem 2rem; /* Larger button */
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s ease-in-out;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
        }
        .message-box button:hover, .modal button:hover {
            background-color: #3182ce; /* Darker blue on hover */
            transform: translateY(-1px); /* Slight lift effect */
        }
        .modal button.bg-red-600 {
            background-color: #dc2626; /* red-600 */
        }
        .modal button.bg-red-600:hover {
            background-color: #b91c1c; /* red-700 */
        }
        .modal button.bg-gray-500 {
            background-color: #6b7280; /* gray-500 */
        }
        .modal button.bg-gray-500:hover {
            background-color: #4b5563; /* gray-600 */
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6); /* Darker overlay */
            z-index: 999;
            display: none;
        }
        #fenceLayoutCanvas {
            width: 100%; /* Ensure responsiveness */
            height: 150px; /* Fixed height for consistency */
            background-color: #fdfefe; /* White background for drawing area */
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-top: 1rem;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        .toggle-btn {
            background-color: #edf2f7; /* Lighter background for toggle */
            color: #2d3748;
            padding: 1rem 1.25rem; /* Larger padding */
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%; /* Ensure full width */
            border: 1px solid #d1d5db; /* Soft border */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin-top: 1.5rem; /* Added margin-top for toggle buttons */
            position: relative; /* Essential for z-index to work */
            z-index: 10; /* Ensure button is on top */
        }
        .toggle-btn:hover {
            background-color: #e2e8f0; /* Slightly darker on hover */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
        }
        .toggle-btn span {
            font-size: 1.2rem; /* Larger text for toggle buttons */
        }
        .toggle-icon {
            transition: transform 0.2s ease-in-out;
        }
        .toggle-icon.rotate {
            transform: rotate(90deg);
        }

        /* Styling for the new multi-line item format */
        .material-line-item {
            display: flex;
            flex-direction: column; /* Stack items vertically */
            padding: 0.5rem 0; /* Vertical padding for each item */
            border-bottom: 1px solid #e2e8f0; /* Separator for each item */
            margin-bottom: 0.5rem; /* Space between items */
        }
        .material-line-item:last-child {
            border-bottom: none; /* No border for the last item */
            margin-bottom: 0;
        }
        .material-line-item .item-name {
            font-weight: 600; /* Bold name */
            color: #2d3748;
            margin-bottom: 0.2rem; /* Small space after name */
        }
        .material-line-item .item-qty-unit {
            color: #4a5568;
            font-size: 0.95rem; /* Slightly smaller font for quantity */
            margin-left: 0.5rem; /* Indent quantity slightly */
            margin-bottom: 0.2rem;
        }
        .material-line-item .item-cost {
            font-weight: 700; /* Bold cost */
            color: #007bff; /* A distinct color for cost */
            text-align: right; /* Align cost to the right */
            font-size: 1rem;
        }
        /* Style for the base cost displayed below the profit-included cost */
        .material-line-item .item-cost .base-cost-display {
            color: #6b7280; /* Gray-500 for subtle text */
            font-size: 0.75rem; /* Smaller font size */
            font-weight: 400; /* Normal weight */
            display: block; /* Ensures it's on a new line */
            margin-top: 0.2rem; /* Small margin above it */
        }

        /* Collapsible content area for advanced settings and results sections */
        .collapsible-content {
            overflow: hidden; /* Crucial for hiding content outside max-height */
            max-height: 0; /* Starts collapsed */
            transition: max-height 0.3s ease-out, padding 0.3s ease-out; /* Smooth transition for height and padding */
            padding-top: 0; /* Start with no vertical padding when hidden */
            padding-bottom: 0; /* Start with no vertical padding when hidden */
            margin-top: 0.5rem; /* Small margin after toggle button */
        }
        .collapsible-content.expanded {
            max-height: 9999px; /* Sufficiently large to show all content when expanded */
            padding-top: 1rem; /* Restore padding when expanded */
            padding-bottom: 1rem; /* Restore padding when expanded */
        }

        /* Professional Quote Summary Styling */
        .professional-quote-summary {
            background-color: #ffffff;
            border-radius: 14px;
            border: 1px solid #cceeff; /* Light blue border */
            padding: 2.5rem;
            margin-top: 3rem;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08); /* Softer shadow */
        }

        .professional-quote-summary h2 {
            font-size: 2rem;
            font-weight: 700;
            color: #2c5282; /* Deep blue */
            margin-bottom: 1.75rem;
            text-align: center;
        }

        .professional-quote-summary .quote-line-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px dashed #e0e0e0;
            font-size: 1.1rem;
            color: #333;
        }

        .professional-quote-summary .quote-line-item:last-of-type {
            border-bottom: none;
            margin-bottom: 0.5rem;
        }

        .professional-quote-summary .quote-line-item .item-description {
            flex-grow: 1;
            padding-right: 1rem;
            font-weight: 500;
        }

        .professional-quote-summary .quote-line-item .item-price {
            font-weight: 700;
            color: #0056b3; /* Darker blue for prices */
        }

        .professional-quote-summary .final-total {
            font-size: 1.75rem;
            /* Removed font-weight and other properties to inherit or match calculator text */
            text-align: right;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 2px solid #aaddff; /* More prominent separator */
            color: #1a202c;
            /* Inherit font-family from body */
            font-family: inherit;
        }
         .professional-quote-summary .final-total span {
            font-weight: 800; /* Keep the actual total price bold */
            color: #0056b3; /* Darker blue for prices */
        }
        /* Added for equal height of input and buttons */
        .flex-stretch-height > * {
            height: auto; /* Allow elements to determine their height */
        }
        .flex-stretch-height {
            display: flex;
            align-items: stretch; /* Stretch children to fill the height */
            gap: 1rem; /* Space between items */
        }
        .flex-stretch-height .input-group {
            margin-bottom: 0; /* Remove bottom margin if part of this flex container */
            flex-grow: 1; /* Allow input to grow */
        }
        .flex-stretch-height button {
            flex-shrink: 0; /* Prevent buttons from shrinking */
        }
        /* Styling for the inner flex containers of motor add-ons to ensure correct alignment */
        #motorInputs .input-group .flex.items-center {
            justify-content: space-between; /* Distribute space between checkbox/label and input */
            width: 100%; /* Ensure it takes full width */
        }
        #motorInputs .input-group .flex.items-center label {
            flex-shrink: 1; /* Allow the label to shrink */
            margin-right: 0.5rem; /* Small margin to separate from input */
        }
        #ziggyRemoteQty {
            flex-shrink: 0; /* Ensure quantity input doesn't shrink */
            width: 80px; /* w-20 = 80px fixed width */
            margin-left: auto; /* Pushes it to the right within the flex container */
        }

        /* Responsive adjustments for smaller screens */
        @media (max-width: 640px) {
            body {
                padding: 0.5rem; /* Further reduced padding on very small screens */
            }
            .container {
                margin: 0;
                border-radius: 0;
                box-shadow: none;
                padding: 0.75rem; /* Further reduced padding inside container on very small screens */
            }
            h1 {
                font-size: 1.5rem; /* Smaller heading for very small screens */
                margin-bottom: 1rem;
            }
            .input-group {
                margin-bottom: 1.25rem; /* Slightly less space between input groups */
            }
            .input-group label {
                margin-bottom: 0.5rem; /* Slightly less space below label */
            }
            .radio-group label {
                margin-right: 1.5rem; /* Less space between radio options on mobile */
            }
            .results-section {
                padding: 1.5rem; /* Reduced padding for results section on mobile */
                margin-top: 2rem;
            }
            .results-section h2 {
                font-size: 1.25rem; /* Smaller results heading for very small screens */
                margin-bottom: 1.25rem;
            }
            .toggle-btn span {
                font-size: 1rem; /* Smaller text for toggle buttons on mobile */
            }
            .results-section .subtotal-line {
                margin-top: 0.75rem;
                padding-top: 0.75rem;
                font-size: 1rem; /* Slightly smaller font for subtotals on mobile */
            }
            .error-message {
                padding: 1rem;
                margin-bottom: 1rem;
            }
            .message-box {
                max-width: 95%;
                padding: 1.5rem;
            }
            .collapsible-content.expanded {
                padding-top: 0.5rem; /* Adjusted padding for smaller screens */
                padding-bottom: 0.5rem;
            }
            .professional-quote-summary {
                padding: 1.5rem;
                margin-top: 2rem;
            }
            .professional-quote-summary h2 {
                font-size: 1.5rem;
            }
            .professional-quote-summary .quote-line-item {
                font-size: 1rem;
                flex-direction: column; /* Stack description and price on small screens */
                align-items: flex-start;
            }
            .professional-quote-summary .quote-line-item .item-price {
                margin-top: 0.25rem; /* Small space when stacked */
            }
            .professional-quote-summary .final-total {
                font-size: 1.5rem;
            }
            /* Adjustments for save/load buttons on mobile */
            .flex-stretch-height {
                flex-direction: column; /* Stack vertically on small screens */
                align-items: stretch; /* Ensure children stretch horizontally */
            }
            .flex-stretch-height button {
                width: 100%; /* Full width for buttons on mobile */
            }
            /* Adjustments for saved quotes list items on mobile */
            #loadQuotesModal .flex-col.md\:flex-row {
                flex-direction: column;
                align-items: flex-start;
            }
            #loadQuotesModal .flex-grow.mb-2.md\:mb-0 {
                width: 100%; /* Ensure text section takes full width */
                margin-bottom: 0.5rem; /* Smaller margin on mobile */
            }
            #loadQuotesModal .flex.space-x-2.w-full.md\:w-auto {
                flex-direction: row; /* Keep buttons in a row */
                justify-content: space-around; /* Distribute space evenly */
                width: 100%; /* Take full width for buttons */
                margin-top: 0.5rem;
            }
            #loadQuotesModal .flex-grow.md\:flex-grow-0 {
                flex-grow: 1; /* Allow buttons to grow and fill space */
                flex-shrink: 1; /* Allow buttons to shrink */
            }
        }

        /* Styles for print only */
        @media print {
            body > *:not(.print-container) {
                display: none !important;
            }
            .print-container {
                display: block !important;
                width: 100%;
                margin: 0;
                padding: 0;
                box-shadow: none;
                border-radius: 0;
            }
            /* Ensure the quote summary styles apply in print */
            .professional-quote-summary {
                margin-top: 0;
                padding: 1.5rem; /* Adjust padding for print */
                box-shadow: none;
                border: none;
            }
            .professional-quote-summary h2 {
                font-size: 1.8rem;
                margin-bottom: 1rem;
            }
            .professional-quote-summary .quote-line-item {
                font-size: 1rem;
            }
            .professional-quote-summary .final-total {
                font-size: 1.5rem;
                margin-top: 1rem;
                padding-top: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">Fencing Quote Calculator</h1>

        <form id="quoteForm" class="space-y-6">
            <!-- Customer Name Input -->
            <div class="input-group">
                <label for="customerName">Customer Name:</label>
                <input type="text" id="customerName" name="customerName" class="mt-1 block w-full" placeholder="e.g., John Smith">
            </div>

            <!-- Overall Boundary Length Input -->
            <div class="input-group">
                <label for="overallBoundaryLength">Overall Boundary Length (mm):</label>
                <input type="number" id="overallBoundaryLength" name="overallBoundaryLength" class="mt-1 block w-full" placeholder="e.g., 20000" min="0">
            </div>

            <!-- Standard Fence Height Input -->
            <div class="input-group">
                <label for="fenceHeight">Fence Height (mm):</label>
                <input type="number" id="fenceHeight" name="fenceHeight" class="mt-1 block w-full" placeholder="e.g., 1800" min="0">
            </div>

            <!-- Post Size Input -->
            <div class="input-group">
                <label for="postSize">Post Size:</label>
                <select id="postSize" name="postSize" class="mt-1 block w-full">
                    <option value="65">65mm x 65mm</option>
                    <option value="89">89mm x 89mm</option>
                </select>
            </div>

            <!-- Post Length Info (Now auto-calculated, no input) -->
            <!-- This section is now hidden, the calculated length will only be displayed in results -->
            <div class="input-group hidden">
                <label>Calculated Post Length (mm):</label>
                <p id="displayPostLength" class="text-gray-700 mt-1"><span class="font-semibold">0mm</span> (Fence Height + 600mm)</p>
            </div>

            <!-- Sliding Gate Input -->
            <div class="input-group">
                <label>Sliding Gate?</label>
                <div class="radio-group flex items-center mt-1">
                    <label class="inline-flex items-center">
                        <input type="radio" name="slidingGate" value="yes" id="slidingGateYes" class="form-radio text-blue-600">
                        <span class="ml-2 text-gray-700">Yes</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="slidingGate" value="no" id="slidingGateNo" class="form-radio text-blue-600" checked>
                        <span class="ml-2 text-gray-700">No</span>
                    </label>
                </div>
            </div>

            <div id="slidingGateInputs" class="hidden pl-6 border-l-2 border-blue-200 ml-2 space-y-4">
                <div class="input-group">
                    <label for="slidingGateLength">Sliding Gate Length (mm):</label>
                    <input type="number" id="slidingGateLength" name="slidingGateLength" class="mt-1 block w-full" placeholder="e.g., 4000">
                </div>
            </div>

            <!-- Gate Motor Input -->
            <div class="input-group">
                <label>Gate Motor?</label>
                <div class="radio-group flex items-center mt-1">
                    <label class="inline-flex items-center">
                        <input type="radio" name="gateMotor" value="yes" id="gateMotorYes" class="form-radio text-blue-600">
                        <span class="ml-2 text-gray-700">Yes</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="gateMotor" value="no" id="gateMotorNo" class="form-radio text-blue-600" checked>
                        <span class="ml-2 text-gray-700">No</span>
                    </label>
                </div>
            </div>

            <div id="motorInputs" class="hidden pl-6 border-l-2 border-blue-200 ml-2 space-y-4">
                <div class="input-group">
                    <label for="motorType">Motor Type:</label>
                    <select id="motorType" name="motorType" class="mt-1 block w-full">
                        <option value="">Select Motor</option>
                        <option value="Livi Split Pack">Livi Split Pack</option>
                        <option value="Livi 24V">Livi 24V</option>
                        <option value="Rev 24V">Rev 24V</option>
                        <option value="30W Solar Kit">30W Solar Kit</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Motor Add-ons:</label>
                    <div class="flex flex-col space-y-2">
                        <div class="flex items-center justify-between">
                            <label class="inline-flex items-center">
                                <input type="checkbox" name="batteryBackup" id="batteryBackup" class="form-checkbox text-blue-600">
                                <span class="ml-2 text-gray-700">Battery backup</span>
                            </label>
                        </div>
                        <div class="flex items-center justify-between">
                            <label class="inline-flex items-center">
                                <input type="checkbox" name="antenna" id="antenna" class="form-checkbox text-blue-600">
                                <span class="ml-2 text-gray-700">Antenna</span>
                            </label>
                        </div>
                        <div class="flex items-center justify-between w-full">
                            <label class="inline-flex items-center">
                                <input type="checkbox" name="ziggyRemote" id="ziggyRemote" class="form-checkbox text-blue-600">
                                <span class="ml-2 text-gray-700">Ziggy Remote</span>
                            </label>
                            <input type="number" id="ziggyRemoteQty" name="ziggyRemoteQty" class="w-20 px-2 py-1 border border-gray-300 rounded-md text-sm" placeholder="Qty" min="1" value="1" disabled>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Pedestrian Gate Input -->
            <div class="input-group">
                <label>Pedestrian Gate?</label>
                <div class="radio-group flex items-center mt-1">
                    <label class="inline-flex items-center">
                        <input type="radio" name="pedestrianGate" value="yes" id="pedestrianGateYes" class="form-radio text-blue-600">
                        <span class="ml-2 text-gray-700">Yes</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="pedestrianGate" value="no" id="pedestrianGateNo" class="form-radio text-blue-600" checked>
                        <span class="ml-2 text-gray-700">No</span>
                    </label>
                </div>
            </div>

            <div id="pedestrianGateInputs" class="hidden pl-6 border-l-2 border-blue-200 ml-2 space-y-4">
                <div class="input-group">
                    <label for="pedestrianGateWidth">Pedestrian Gate Width (mm):</label>
                    <input type="number" id="pedestrianGateWidth" name="pedestrianGateWidth" class="mt-1 block w-full" placeholder="e.g., 900">
                </div>
                <div class="input-group">
                    <label for="hingeType">Hinge Type:</label>
                    <select id="hingeType" name="hingeType" class="mt-1 block w-full">
                        <option value="Adjustable Hinges">Adjustable Hinges</option>
                        <option value="Truclose Hinges">Truclose Hinges</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="latchType">Latch Type:</label>
                    <select id="latchType" name="latchType" class="mt-1 block w-full">
                        <option value="D latch">D latch</option>
                        <option value="Lokk Latch Deluxe">Lokk Latch Deluxe</option>
                        <option value="001 Deadlock">001 Deadlock</option>
                    </select>
                </div>
            </div>

            <!-- Fence Panels Info -->
            <div class="input-group">
                <label>Fence Panel Details (Calculated from overall boundary):</label>
                <div id="calculatedPanelsInfo" class="space-y-2 mt-1 text-gray-700">
                    <p id="displayNumPanels" class="hidden">Number of Panels: <span class="font-semibold">0</span></p>
                    <p id="displayPanelLength" class="hidden">Panel Length: <span class="font-semibold">0mm</span></p>
                    <p id="displayFenceLinearLength" class="hidden">Total Linear Fence Length: <span class="font-semibold">0mm</span></p>
                    <p class="text-sm text-gray-500 mt-2" id="panelHint">Enter overall boundary length to calculate panels.</p>
                </div>
            </div>

            <!-- Advanced Settings Section -->
            <div class="bg-gray-100 p-4 rounded-lg shadow-inner mt-6">
                <button type="button" class="toggle-btn" id="toggleAdvancedSettings" data-target="advancedSettingsContent">
                    <span>Advanced Settings</span>
                    <span class="toggle-icon">▶</span>
                </button>
                <div id="advancedSettingsContent" class="collapsible-content">
                    <h3 class="text-lg font-semibold text-gray-700 border-b pb-2 mb-3">Profit Margins</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="input-group">
                            <label for="profitSlidingGateMaterial">Sliding Gate Material:</label>
                            <div class="relative mt-1">
                                <input type="number" id="profitSlidingGateMaterial" class="block w-full input-with-symbol-right" min="0" max="100" step="1">
                                <span class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none text-gray-500">%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="profitPedestrianGateMaterial">Pedestrian Gate Material:</label>
                            <div class="relative mt-1">
                                <input type="number" id="profitPedestrianGateMaterial" class="block w-full input-with-symbol-right" min="0" max="100" step="1">
                                <span class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none text-gray-500">%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="profitPanelsMaterial">Panels:</label>
                            <div class="relative mt-1">
                                <input type="number" id="profitPanelsMaterial" class="block w-full input-with-symbol-right" min="0" max="100" step="1">
                                <span class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none text-gray-500">%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="profitPostsMaterial">Posts:</label>
                            <div class="relative mt-1">
                                <input type="number" id="profitPostsMaterial" class="block w-full input-with-symbol-right" min="0" max="100" step="1">
                                <span class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none text-gray-500">%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="profitCapsBracketsMaterial">Caps & Brackets:</label>
                            <div class="relative mt-1">
                                <input type="number" id="profitCapsBracketsMaterial" class="block w-full input-with-symbol-right" min="0" max="100" step="1">
                                <span class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none text-gray-500">%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="profitPowderCoating">Powder Coating:</label>
                            <div class="relative mt-1">
                                <input type="number" id="profitPowderCoating" class="block w-full input-with-symbol-right" min="0" max="100" step="1">
                                <span class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none text-gray-500">%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="profitGateMotors">Gate Motors:</label>
                            <div class="relative mt-1">
                                <input type="number" id="profitGateMotors" class="block w-full input-with-symbol-right" min="0" max="100" step="1">
                                <span class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none text-gray-500">%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="profitGateMotorHardware">Gate Motor Hardware:</label>
                            <div class="relative mt-1">
                                <input type="number" id="profitGateMotorHardware" class="block w-full input-with-symbol-right" min="0" max="100" step="1">
                                <span class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none text-gray-500">%</span>
                            </div>
                        </div>
                    </div>

                    <h3 class="text-lg font-semibold text-gray-700 border-b pb-2 mb-3 mt-6">Installation Costs</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="input-group">
                            <label for="installPostsFixed">Posts (per job):</label>
                            <div class="relative mt-1">
                                <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-500">$</span>
                                <input type="number" id="installPostsFixed" class="block w-full input-with-symbol-left" min="0" step="1">
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="installSlidingGateFixed">Sliding Gates (fixed):</label>
                            <div class="relative mt-1">
                                <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-500">$</span>
                                <input type="number" id="installSlidingGateFixed" class="block w-full input-with-symbol-left" min="0" step="1">
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="installPedestrianGateFixed">Pedestrian Gates (fixed):</label>
                            <div class="relative mt-1">
                                <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-500">$</span>
                                <input type="number" id="installPedestrianGateFixed" class="block w-full input-with-symbol-left" min="0" step="1">
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="installPanelsPerMeter">Panels (per meter):</label>
                            <div class="relative mt-1">
                                <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-500">$</span>
                                <input type="number" id="installPanelsPerMeter" class="block w-full input-with-symbol-left" min="0" step="1">
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="installMotorFixed">Motor Installation (fixed):</label>
                            <div class="relative mt-1">
                                <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-500">$</span>
                                <input type="number" id="installMotorFixed" class="block w-full input-with-symbol-left" min="0" step="1">
                            </div>
                        </div>
                    </div>

                    <h3 class="text-lg font-semibold text-gray-700 border-b pb-2 mb-3 mt-6">Fabrication Costs</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="input-group">
                            <label for="fabricationCostPerDay">Fabrication Cost per Day:</label>
                            <div class="relative mt-1">
                                <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-500">$</span>
                                <input type="number" id="fabricationCostPerDay" class="block w-full input-with-symbol-left" min="0" step="1">
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="fabricationDaysPerJob">Standard Fabrication Days per Job:</label>
                            <div class="relative mt-1">
                                <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-500">$</span>
                                <input type="number" id="fabricationDaysPerJob" class="block w-full input-with-symbol-left" min="0" step="1">
                            </div>
                        </div>
                    </div>

                    <h3 class="text-lg font-semibold text-gray-700 border-b pb-2 mb-3 mt-6">Material Costs (Base Prices)</h3>
                    <div id="materialCostInputs" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Material cost inputs will be dynamically inserted here -->
                    </div>
                </div>
            </div>

            <!-- Action Buttons for Save/Load/Print -->
            <div class="flex flex-col md:flex-row flex-stretch-height gap-4 mt-6">
                <div class="input-group flex-grow">
                    <label for="quoteNameInput" class="sr-only">Quote Name (for saving)</label>
                    <input type="text" id="quoteNameInput" placeholder="Enter a name for your quote" class="mt-1 block w-full py-3 px-4">
                </div>
                <button type="button" id="saveQuoteBtn" onclick="saveQuote()" class="w-full md:w-auto bg-green-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-green-700 transition duration-200 ease-in-out shadow-md">
                    Save Quote
                </button>
                <button type="button" id="loadQuotesBtn" onclick="showLoadQuotesModal()" class="w-full md:w-auto bg-purple-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-purple-700 transition duration-200 ease-in-out shadow-md">
                    Load Quotes
                </button>
                <button type="button" id="printQuoteBtn" onclick="printQuoteSummary()" class="w-full md:w-auto bg-gray-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-gray-700 transition duration-200 ease-in-out shadow-md">
                    Print Quote
                </button>
            </div>


            <!-- Calculate Button -->
            <button type="submit" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-blue-700 transition duration-200 ease-in-out shadow-md">
                Calculate Quote
            </button>
        </form>

        <!-- Results Display Section -->
        <div id="results" class="results-section hidden">
            <h2 class="text-center">Material Requirements & Costs</h2>
            <div id="materialDetails" class="mt-4 text-gray-700 space-y-2">

                <!-- Layout Overview Section -->
                <h3 class="mt-6">Layout Overview (Bird's Eye View)</h3>
                <div class="flex justify-center items-center py-4">
                    <canvas id="fenceLayoutCanvas" width="800" height="150" class="border border-gray-300 bg-white rounded-md"></canvas>
                </div>
                <p class="text-sm text-gray-500 text-center mb-4">Scale: Not to scale, represents relative lengths.</p>

                <!-- Posts Section -->
                <div id="postsSection" class="hidden">
                    <button type="button" class="toggle-btn" data-target="postsContent">
                        <span id="postsSectionTitle">Posts</span>
                        <span class="toggle-icon">▶</span>
                    </button>
                    <div id="postsContent" class="collapsible-content">
                        <div class="material-line-item">
                            <div class="item-name">Calculated Number of Posts:</div>
                            <div class="item-qty-unit" id="calculatedNumPostsDisplay">0</div>
                        </div>
                        <div class="material-line-item">
                            <div class="item-name">Calculated Post Length:</div>
                            <div class="item-qty-unit" id="calculatedPostLengthDisplay">0mm</div>
                        </div>
                        <div id="postsMaterials" class="space-y-1"></div>
                        <p class="subtotal-line flex justify-between">Subtotal for Posts: <span id="postsSubtotal" class="font-semibold text-gray-800">$0.00</span></p>
                    </div>
                </div>

                <!-- Sliding Gate Section -->
                <div id="slidingGateSection" class="hidden">
                    <button type="button" class="toggle-btn" data-target="slidingGateContent">
                        <span id="slidingGateSectionTitle">Sliding Gate</span>
                        <span class="toggle-icon">▶</span>
                    </button>
                    <div id="slidingGateContent" class="collapsible-content">
                        <div id="slidingGateMaterials" class="space-y-1"></div>
                        <p class="subtotal-line flex justify-between">Subtotal for Sliding Gate: <span id="slidingGateSubtotal" class="font-semibold text-gray-800">$0.00</span></p>
                    </div>
                </div>

                <!-- Sliding Gate Fittings Section -->
                <div id="slidingGateFittingsSection" class="hidden">
                    <button type="button" class="toggle-btn" data-target="slidingGateFittingsContent">
                        <span id="slidingGateFittingsSectionTitle">Sliding Gate Fittings</span>
                        <span class="toggle-icon">▶</span>
                    </button>
                    <div id="slidingGateFittingsContent" class="collapsible-content">
                        <div id="slidingGateFittingsMaterials" class="space-y-1"></div>
                        <p class="subtotal-line flex justify-between">Subtotal for Sliding Gate Fittings: <span id="slidingGateFittingsSubtotal" class="font-semibold text-gray-800">$0.00</span></p>
                    </div>
                </div>

                <!-- Gate Motors & Accessories Section -->
                <div id="gateMotorsSection" class="hidden">
                    <button type="button" class="toggle-btn" data-target="gateMotorsContent">
                        <span id="gateMotorsSectionTitle">Gate Motors & Accessories</span>
                        <span class="toggle-icon">▶</span>
                    </button>
                    <div id="gateMotorsContent" class="collapsible-content">
                        <div id="gateMotorsMaterials" class="space-y-1"></div>
                        <p class="subtotal-line flex justify-between">Subtotal for Gate Motors & Accessories: <span id="gateMotorsSubtotal" class="font-semibold text-gray-800">$0.00</span></p>
                    </div>
                </div>

                <!-- Pedestrian Gate Section -->
                <div id="pedestrianGateSection" class="hidden">
                    <button type="button" class="toggle-btn" data-target="pedestrianGateContent">
                        <span id="pedestrianGateSectionTitle">Pedestrian Gate</span>
                        <span class="toggle-icon">▶</span>
                    </button>
                    <div id="pedestrianGateContent" class="collapsible-content">
                        <div id="pedestrianGateMaterials" class="space-y-1"></div>
                        <p class="subtotal-line flex justify-between">Subtotal for Pedestrian Gate: <span id="pedestrianGateSubtotal" class="font-semibold text-gray-800">$0.00</span></p>
                    </div>
                </div>

                <!-- Fence Panels Section -->
                <div id="fencePanelsSection" class="hidden">
                    <button type="button" class="toggle-btn" data-target="fencePanelsContent">
                        <span id="fencePanelsSectionTitle">Fence Panels</span>
                        <span class="toggle-icon">▶</span>
                    </button>
                    <div id="fencePanelsContent" class="collapsible-content">
                        <div class="material-line-item">
                            <div class="item-name">Number of Panels:</div>
                            <div class="item-qty-unit" id="displayNumPanelsActual">0</div>
                        </div>
                        <div class="material-line-item">
                            <div class="item-name">Panel Length:</div>
                            <div class="item-qty-unit" id="displayPanelLengthActual">0mm</div>
                        </div>
                        <div class="material-line-item">
                            <div class="item-name">Total Linear Fence Length:</div>
                            <div class="item-qty-unit" id="displayFenceLinearLengthActual">0mm</div>
                        </div>
                        <h4 class="font-semibold text-gray-700 mt-4 mb-2">Panel Materials:</h4>
                        <div id="fencePanelsMaterials" class="space-y-1"></div>
                        <p class="subtotal-line flex justify-between">Subtotal for Fence Panels: <span id="fencePanelsSubtotal" class="font-semibold text-gray-800">$0.00</span></p>
                    </div>
                </div>

                <!-- Powder Coating Section -->
                <div id="powderCoatingSection" class="hidden">
                    <button type="button" class="toggle-btn" data-target="powderCoatingContent">
                        <span id="powderCoatingSectionTitle">Powder Coating</span>
                        <span class="toggle-icon">▶</span>
                    </button>
                    <div id="powderCoatingContent" class="collapsible-content">
                        <div id="powderCoatingDetails" class="mt-4 text-gray-700 space-y-2">
                            <!-- Powder coating breakdown will be inserted here -->
                        </div>
                        <p class="subtotal-line flex justify-between text-blue-700">Total Powder Coating Cost: <span id="powderCoatingTotal" class="font-semibold text-blue-800 text-lg">$0.00</span></p>
                    </div>
                </div>

                <!-- Fabrication Section -->
                <div id="fabricationCostsSection" class="hidden">
                    <button type="button" class="toggle-btn" data-target="fabricationContent">
                        <span id="fabricationCostsSectionTitle">Fabrication</span>
                        <span class="toggle-icon">▶</span>
                    </button>
                    <div id="fabricationContent" class="collapsible-content">
                        <div id="fabricationDetails" class="mt-4 text-gray-700 space-y-2">
                            <!-- Fabrication breakdown will be inserted here -->
                        </div>
                        <p class="subtotal-line flex justify-between text-orange-700">Total Fabrication Cost: <span id="fabricationTotal" class="font-semibold text-orange-800 text-lg">$0.00</span></p>
                    </div>
                </div>

                <!-- Installation Section -->
                <div id="installationCostsSection" class="hidden">
                    <button type="button" class="toggle-btn" data-target="installationContent">
                        <span id="installationCostsSectionTitle">Installation</span>
                        <span class="toggle-icon">▶</span>
                    </button>
                    <div id="installationContent" class="collapsible-content">
                        <div id="installationDetails" class="mt-4 text-gray-700 space-y-2">
                            <!-- Installation breakdown will be inserted here -->
                        </div>
                        <p class="subtotal-line flex justify-between text-green-700">Total Installation Cost: <span id="installationTotal" class="font-semibold text-green-800 text-lg">$0.00</span></p>
                    </div>
                </div>

            </div>
            <p class="text-right text-lg font-bold mt-6 text-gray-800">Quote Total: <span id="totalCost" class="text-blue-600">$0.00</span></p>

            <!-- Professional Quote Summary Section -->
            <div id="professionalQuoteSummary" class="professional-quote-summary hidden">
                <h2 class="text-center mb-6">Quote Summary</h2>
                <div id="customerNameDisplay" class="text-center text-lg font-semibold text-gray-700 mb-4"></div> <!-- Added for customer name -->
                <div id="quoteSummaryItems" class="space-y-3">
                    <!-- Quote line items will be inserted here -->
                </div>
                <div class="final-total">
                    Quote Total: <span id="finalProfessionalQuoteTotal">$0.00</span>
                </div>
            </div>

        </div>
    </div>

    <!-- Message Box for Alerts -->
    <div id="messageBox" class="message-box">
        <h3 id="messageBoxTitle"></h3>
        <p id="messageBoxContent"></p>
        <button onclick="closeMessageBox()">OK</button>
    </div>

    <!-- Load Quotes Modal -->
    <div id="loadQuotesModal" class="modal">
        <h3>Your Saved Quotes</h3>
        <div id="savedQuotesList" class="my-4 text-left">
            <p class="text-gray-500 text-center">No quotes saved locally.</p>
        </div>
        <button onclick="closeLoadQuotesModal()">Close</button>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmModal" class="modal">
        <h3>Confirm Deletion</h3>
        <p id="deleteConfirmMessage" class="mb-6"></p>
        <div class="flex justify-center space-x-4">
            <button onclick="confirmDelete()" class="bg-red-600 hover:bg-red-700">Delete</button>
            <button onclick="closeDeleteConfirmModal()" class="bg-gray-500 hover:bg-gray-600">Cancel</button>
        </div>
    </div>


    <div id="overlay" class="overlay" onclick="closeMessageBox(); closeLoadQuotesModal(); closeDeleteConfirmModal()"></div>

    <script>
        // Default Material price list with their respective stock lengths and costs
        // This will be used to populate the editable inputs initially
        const defaultMaterialPriceList = {
            '100x50 RHS': { pricePerUnit: 81.58, unitLength: 8000 },
            '40x40 SHS': { pricePerUnit: 35.72, unitLength: 8000 },
            '50x10 Pickets': { pricePerUnit: 19.72, unitLength: 7320 },
            'Picket Top': { pricePerUnit: 1.69, unitLength: 1 },
            '89x89 Post': { pricePerUnit: 97.50, unitLength: 8000 },
            '65x65 Post': { pricePerUnit: 59.48, unitLength: 8000 },
            '40x40 Angle': { pricePerUnit: 28.45, unitLength: 6000 },
            // Gate Hardware Costs
            'Adjustable Hinges': { pricePerUnit: 18.15, unitLength: 1 }, // each
            'Truclose Hinges': { pricePerUnit: 80.64, unitLength: 1 },    // each
            'D latch': { pricePerUnit: 6.85, unitLength: 1 },           // each
            'Lokk Latch Deluxe': { pricePerUnit: 70.25, unitLength: 1 },  // each
            '001 Deadlock': { pricePerUnit: 138.50, unitLength: 1 },      // each
            // Fencing Specific Accessories
            '40x40 Rail Brackets': { pricePerUnit: 2.25, unitLength: 1 },
            '90x90 Caps': { pricePerUnit: 3.80, unitLength: 1 },
            '65x65 Caps': { pricePerUnit: 1.25, unitLength: 1 },
            // Sliding Gate Fittings
            'Guide Rollers': { pricePerUnit: 8.15, unitLength: 1 },
            'Guide Bracket': { pricePerUnit: 8.85, unitLength: 1 },
            '100x50 Cap': { pricePerUnit: 6.58, unitLength: 1 },
            'Gate Wheel': { pricePerUnit: 20.16, unitLength: 1 },
            '50mm Catch': { pricePerUnit: 18.56, unitLength: 1 },
            'Gate Track': { pricePerUnit: 32.60, unitLength: 3000 }, // Price per 3-meter length
            // Gate Motors
            'Livi Split Pack': { pricePerUnit: 859.32, unitLength: 1 },
            'Livi 24V': { pricePerUnit: 614.24, unitLength: 1 },
            'Rev 24V': { pricePerUnit: 1043.46, unitLength: 1 },
            '30W Solar Kit': { pricePerUnit: 969.70, unitLength: 1 },
            // Motor Accessories
            'Gear rack': { pricePerUnit: 23.85, unitLength: 1000 }, // Price per 1-meter length (1000mm)
            'Battery backup': { pricePerUnit: 68.97, unitLength: 1 },
            'Antenna': { pricePerUnit: 42.55, unitLength: 1 },
            'Ziggy Remote': { pricePerUnit: 47.65, unitLength: 1 },
        };

        // Powder Coating Rates - these remain fixed in the code as they are not user-editable via inputs
        const powderCoatingRates = {
            '65x65 Post': 5.50,   // per meter
            '89x89 Post': 7.70,   // per meter (assuming 90x90 means 89x89)
            'Panel_Gate_Area': 55.00, // per square meter
            'Per_Piece_Powder_Coat': 2.00 // General rate for individual items like caps, rail brackets, hinges, latches
        };

        // Default Installation Rates - now used to populate inputs
        const DEFAULT_INSTALL_POSTS_FIXED = 1250;
        const DEFAULT_INSTALL_SLIDING_GATE_FIXED = 1750;
        const DEFAULT_INSTALL_PEDESTRIAN_GATE_FIXED = 750;
        const DEFAULT_INSTALL_PANELS_PER_METER = 65;
        const DEFAULT_INSTALL_MOTOR_FIXED = 1000; // New default motor installation cost

        // Default Fabrication Rates
        const DEFAULT_FABRICATION_COST_PER_DAY = 1250;
        const DEFAULT_FABRICATION_DAYS_PER_JOB = 2;


        // Default Profit Margins - now used to populate inputs
        const DEFAULT_PROFIT_SLIDING_GATE_MATERIAL = 0.55; // 55%
        const DEFAULT_PROFIT_PEDESTRIAN_GATE_MATERIAL = 0.55; // 55%
        const DEFAULT_PROFIT_PANELS_MATERIAL = 0.50; // 50%
        const DEFAULT_PROFIT_POSTS_MATERIAL = 0.30; // 30% for posts
        const DEFAULT_PROFIT_CAPS_BRACKETS_MATERIAL = 0.35; // 35% for caps and brackets
        const DEFAULT_PROFIT_POWDER_COATING = 0.25; // 25%
        const DEFAULT_PROFIT_GATE_MOTORS = 0.55; // 55%
        const DEFAULT_PROFIT_GATE_MOTOR_HARDWARE = 0.70; // 70%

        // Constants for panel optimization
        const IDEAL_PANEL_2_4M = 2400; // 2.4 meters

        // Local Storage Keys
        const SETTINGS_STORAGE_KEY = 'fencingQuoteSettings';
        const QUOTES_STORAGE_KEY = 'fencingSavedQuotes';


        // Get references to DOM elements
        const customerNameInput = document.getElementById('customerName'); // New customer name input
        const overallBoundaryLengthInput = document.getElementById('overallBoundaryLength');
        const fenceHeightInput = document.getElementById('fenceHeight'); // Global fence height input
        const postSizeSelect = document.getElementById('postSize'); // Renamed for clarity

        const slidingGateYes = document.getElementById('slidingGateYes');
        const slidingGateNo = document.getElementById('slidingGateNo');
        const slidingGateInputs = document.getElementById('slidingGateInputs');
        const slidingGateLengthInput = document.getElementById('slidingGateLength');

        const gateMotorYes = document.getElementById('gateMotorYes');
        const gateMotorNo = document.getElementById('gateMotorNo');
        const motorInputs = document.getElementById('motorInputs');
        const motorTypeSelect = document.getElementById('motorType');
        const batteryBackupCheckbox = document.getElementById('batteryBackup');
        const antennaCheckbox = document.getElementById('antenna');
        const ziggyRemoteCheckbox = document.getElementById('ziggyRemote');
        const ziggyRemoteQtyInput = document.getElementById('ziggyRemoteQty');


        const pedestrianGateYes = document.getElementById('pedestrianGateYes');
        const pedestrianGateNo = document.getElementById('pedestrianGateNo');
        const pedestrianGateInputs = document.getElementById('pedestrianGateInputs');
        const pedestrianGateWidthInput = document.getElementById('pedestrianGateWidth');
        const hingeTypeSelect = document.getElementById('hingeType');
        const latchTypeSelect = document.getElementById('latchType');

        const quoteForm = document.getElementById('quoteForm');
        const resultsDiv = document.getElementById('results');
        const materialDetailsDiv = document.getElementById('materialDetails');
        const totalCostSpan = document.getElementById('totalCost');

        const postsSection = document.getElementById('postsSection');
        const postsSectionTitle = document.getElementById('postsSectionTitle');
        const postsMaterialsDiv = document.getElementById('postsMaterials');
        const calculatedNumPostsDisplay = document.getElementById('calculatedNumPostsDisplay');
        const calculatedPostLengthDisplay = document.getElementById('calculatedPostLengthDisplay');
        const postsSubtotalSpan = document.getElementById('postsSubtotal');

        const slidingGateSection = document.getElementById('slidingGateSection');
        const slidingGateSectionTitle = document.getElementById('slidingGateSectionTitle');
        const slidingGateMaterialsDiv = document.getElementById('slidingGateMaterials');
        const slidingGateSubtotalSpan = document.getElementById('slidingGateSubtotal');

        const slidingGateFittingsSection = document.getElementById('slidingGateFittingsSection');
        const slidingGateFittingsSectionTitle = document.getElementById('slidingGateFittingsSectionTitle');
        const slidingGateFittingsMaterialsDiv = document.getElementById('slidingGateFittingsMaterials');
        const slidingGateFittingsSubtotalSpan = document.getElementById('slidingGateFittingsSubtotal');

        const gateMotorsSection = document.getElementById('gateMotorsSection');
        const gateMotorsSectionTitle = document.getElementById('gateMotorsSectionTitle');
        const gateMotorsMaterialsDiv = document.getElementById('gateMotorsMaterials');
        const gateMotorsSubtotalSpan = document.getElementById('gateMotorsSubtotal');

        const pedestrianGateSection = document.getElementById('pedestrianGateSection');
        const pedestrianGateSectionTitle = document = document.getElementById('pedestrianGateSectionTitle');
        const pedestrianGateMaterialsDiv = document.getElementById('pedestrianGateMaterials');
        const pedestrianGateSubtotalSpan = document.getElementById('pedestrianGateSubtotal');

        const fencePanelsSection = document.getElementById('fencePanelsSection');
        const fencePanelsSectionTitle = document.getElementById('fencePanelsSectionTitle');
        const fencePanelsInfoDiv = document.getElementById('fencePanelsInfo');
        const fencePanelsMaterialsDiv = document.getElementById('fencePanelsMaterials'); // New element for panel materials
        const fencePanelsSubtotalSpan = document.getElementById('fencePanelsSubtotal');
        const displayNumPanels = document.getElementById('displayNumPanels'); // Original display elements
        const displayPanelLength = document.getElementById('displayPanelLength');
        const displayFenceLinearLength = document.getElementById('displayFenceLinearLength');
        const displayNumPanelsActual = document.getElementById('displayNumPanelsActual'); // New elements for multi-line display
        const displayPanelLengthActual = document.getElementById('displayPanelLengthActual');
        const displayFenceLinearLengthActual = document.getElementById('displayFenceLinearLengthActual');

        const panelHint = document.getElementById('panelHint');

        const powderCoatingSection = document.getElementById('powderCoatingSection');
        const powderCoatingSectionTitle = document.getElementById('powderCoatingSectionTitle');
        const powderCoatingDetailsDiv = document.getElementById('powderCoatingDetails');
        const powderCoatingTotalSpan = document.getElementById('powderCoatingTotal');

        // Installation and Profit display elements
        const installationCostsSection = document.getElementById('installationCostsSection');
        const installationCostsSectionTitle = document.getElementById('installationCostsSectionTitle');
        const installationDetailsDiv = document.getElementById('installationDetails');
        const installationTotalSpan = document.getElementById('installationTotal');

        // Fabrication display elements
        const fabricationCostsSection = document.getElementById('fabricationCostsSection');
        const fabricationCostsSectionTitle = document.getElementById('fabricationCostsSectionTitle');
        const fabricationDetailsDiv = document.getElementById('fabricationDetails');
        const fabricationTotalSpan = document.getElementById('fabricationTotal');


        // Advanced Settings UI elements
        const toggleAdvancedSettingsBtn = document.getElementById('toggleAdvancedSettings');
        const advancedSettingsContent = document.getElementById('advancedSettingsContent');
        const toggleIcon = toggleAdvancedSettingsBtn.querySelector('.toggle-icon');

        // Input fields for dynamic rates and margins
        const profitSlidingGateMaterialInput = document.getElementById('profitSlidingGateMaterial');
        const profitPedestrianGateMaterialInput = document.getElementById('profitPedestrianGateMaterial');
        const profitPanelsMaterialInput = document.getElementById('profitPanelsMaterial');
        const profitPostsMaterialInput = document.getElementById('profitPostsMaterial'); // New input
        const profitCapsBracketsMaterialInput = document.getElementById('profitCapsBracketsMaterial'); // New input
        const profitPowderCoatingInput = document.getElementById('profitPowderCoating');
        const profitGateMotorsInput = document.getElementById('profitGateMotors');
        const profitGateMotorHardwareInput = document.getElementById('profitGateMotorHardware');

        const installPostsFixedInput = document.getElementById('installPostsFixed');
        const installSlidingGateFixedInput = document.getElementById('installSlidingGateFixed');
        const installPedestrianGateFixedInput = document.getElementById('installPedestrianGateFixed');
        const installPanelsPerMeterInput = document.getElementById('installPanelsPerMeter');
        const installMotorFixedInput = document.getElementById('installMotorFixed'); // New motor installation input

        // Fabrication input fields
        const fabricationCostPerDayInput = document.getElementById('fabricationCostPerDay');
        const fabricationDaysPerJobInput = document.getElementById('fabricationDaysPerJob');

        // New material cost inputs container
        const materialCostInputsDiv = document.getElementById('materialCostInputs');

        // Professional Quote Summary elements
        const professionalQuoteSummaryDiv = document.getElementById('professionalQuoteSummary');
        const customerNameDisplay = document.getElementById('customerNameDisplay'); // New element for customer name in summary
        const quoteSummaryItemsDiv = document.getElementById('quoteSummaryItems');
        const finalProfessionalQuoteTotalSpan = document.getElementById('finalProfessionalQuoteTotal');


        const fenceLayoutCanvas = document.getElementById('fenceLayoutCanvas');
        const ctx = fenceLayoutCanvas.getContext('2d');


        const messageBox = document.getElementById('messageBox');
        const messageBoxTitle = document.getElementById('messageBoxTitle');
        const messageBoxContent = document.getElementById('messageBoxContent');
        const overlay = document.getElementById('overlay');
        const loadQuotesModal = document.getElementById('loadQuotesModal'); // New modal for loading quotes

        let quoteToDeleteId = null; // Temporarily store the ID of the quote to delete

        // --- Local Storage Quote Management ---

        /**
         * Generates a simple unique ID for local storage quotes.
         * @returns {string} A unique ID.
         */
        function generateUniqueId() {
            return 'quote_' + Date.now() + '_' + Math.random().toString(36).substring(2, 9);
        }

        /**
         * Saves the current quote to localStorage.
         */
        window.saveQuote = function() {
            console.log("Save Quote button clicked.");

            const quoteNameInput = document.getElementById('quoteNameInput');
            const quoteName = quoteNameInput.value.trim();
            if (!quoteName) {
                showMessageBox("Input Required", "Please enter a name for your quote before saving.");
                return;
            }

            // Get current input values to save them for loading later
            const inputValues = {
                customerName: customerNameInput.value, // Save customer name
                overallBoundaryLength: overallBoundaryLengthInput.value,
                fenceHeight: fenceHeightInput.value,
                postSize: postSizeSelect.value,
                slidingGate: slidingGateYes.checked,
                slidingGateLength: slidingGateLengthInput.value,
                gateMotor: gateMotorYes.checked,
                motorType: motorTypeSelect.value,
                batteryBackup: batteryBackupCheckbox.checked,
                antenna: antennaCheckbox.checked,
                ziggyRemote: ziggyRemoteCheckbox.checked,
                ziggyRemoteQty: ziggyRemoteQtyInput.value,
                pedestrianGate: pedestrianGateYes.checked,
                pedestrianGateWidth: pedestrianGateWidthInput.value,
                hingeType: hingeTypeSelect.value,
                latchType: latchTypeSelect.value,
                profitSlidingGateMaterial: profitSlidingGateMaterialInput.value,
                profitPedestrianGateMaterial: profitPedestrianGateMaterialInput.value,
                profitPanelsMaterial: profitPanelsMaterialInput.value,
                profitPostsMaterial: profitPostsMaterialInput.value,
                profitCapsBracketsMaterial: profitCapsBracketsMaterialInput.value,
                profitPowderCoating: profitPowderCoatingInput.value,
                profitGateMotors: profitGateMotorsInput.value,
                profitGateMotorHardware: profitGateMotorHardwareInput.value,
                installPostsFixed: installPostsFixedInput.value,
                installSlidingGateFixed: installSlidingGateFixedInput.value,
                installPedestrianGateFixed: installPedestrianGateFixedInput.value,
                installPanelsPerMeter: installPanelsPerMeterInput.value,
                installMotorFixed: installMotorFixedInput.value,
                fabricationCostPerDay: fabricationCostPerDayInput.value,
                fabricationDaysPerJob: fabricationDaysPerJobInput.value,
                materialCosts: {} // Capture current material costs
            };

            for (const key in defaultMaterialPriceList) {
                const inputId = `material-${key.replace(/\s+/g, '-')}-cost`;
                const inputElement = document.getElementById(inputId);
                if (inputElement) {
                    inputValues.materialCosts[key] = inputElement.value;
                }
            }

            const newQuote = {
                id: generateUniqueId(),
                name: quoteName,
                timestamp: Date.now(),
                inputValues: inputValues,
                calculatedTotal: document.getElementById('totalCost').textContent,
                quoteSummaryHtml: document.getElementById('quoteSummaryItems').innerHTML
            };

            let savedQuotes = JSON.parse(localStorage.getItem(QUOTES_STORAGE_KEY) || '[]');
            savedQuotes.push(newQuote);

            try {
                localStorage.setItem(QUOTES_STORAGE_KEY, JSON.stringify(savedQuotes));
                showMessageBox("Quote Saved!", `Your quote "${quoteName}" has been saved locally.`);
                quoteNameInput.value = ''; // Clear the input after saving
                loadSavedQuotes(); // Refresh the list of saved quotes in the modal
            } catch (e) {
                console.error("Error saving quote to local storage:", e);
                showMessageBox("Error Saving", `Failed to save quote locally: ${e.message}. Local storage might be full or disabled.`);
            }
        };

        /**
         * Loads saved quotes from localStorage and displays them in the modal.
         */
        window.loadSavedQuotes = function() {
            console.log("Loading saved quotes from local storage...");
            const savedQuotesList = document.getElementById('savedQuotesList');
            savedQuotesList.innerHTML = '<p class="text-gray-500 text-center">Loading quotes...</p>';

            try {
                const savedQuotes = JSON.parse(localStorage.getItem(QUOTES_STORAGE_KEY) || '[]');
                savedQuotesList.innerHTML = ''; // Clear loading indicator

                if (savedQuotes.length === 0) {
                    savedQuotesList.innerHTML = '<p class="text-gray-500 text-center">No saved quotes found locally.</p>';
                    return;
                }

                savedQuotes.forEach((quote) => {
                    const timestamp = new Date(quote.timestamp).toLocaleString();
                    const listItem = document.createElement('div');
                    listItem.className = 'flex flex-col md:flex-row items-start md:items-center justify-between bg-white p-4 rounded-lg shadow-md mb-3 border border-gray-200';
                    listItem.innerHTML = `
                        <div class="flex-grow mb-2 md:mb-0">
                            <h4 class="font-bold text-lg text-gray-800">${quote.name}</h4>
                            <p class="text-sm text-gray-500 mt-1">Saved: ${timestamp}</p>
                        </div>
                        <div class="flex space-x-2 flex-shrink-0 w-full md:w-auto justify-end md:justify-start">
                            <button onclick="displayLoadedQuote('${quote.id}')" class="bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-blue-600 transition-colors shadow flex-grow md:flex-grow-0">Load</button>
                            <button onclick="showDeleteConfirmModal('${quote.id}', '${quote.name}')" class="bg-red-500 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-red-600 transition-colors shadow flex-grow md:flex-grow-0">Delete</button>
                        </div>
                    `;
                    savedQuotesList.appendChild(listItem);
                });
            } catch (e) {
                console.error("Error loading quotes from local storage: ", e);
                savedQuotesList.innerHTML = `<p class="text-red-500 text-center">Error loading quotes: ${e.message}</p>`;
            }
        };

        /**
         * Displays a loaded quote's details in the main form.
         * @param {string} quoteId - The ID of the quote to load.
         */
        window.displayLoadedQuote = function(quoteId) {
            console.log("Displaying loaded quote:", quoteId);
            try {
                const savedQuotes = JSON.parse(localStorage.getItem(QUOTES_STORAGE_KEY) || '[]');
                const selectedQuoteData = savedQuotes.find(quote => quote.id === quoteId);

                if (selectedQuoteData && selectedQuoteData.inputValues) {
                    const inputValues = selectedQuoteData.inputValues;

                    // Populate customer name
                    customerNameInput.value = inputValues.customerName || '';

                    // Populate form fields with saved input values
                    overallBoundaryLengthInput.value = inputValues.overallBoundaryLength || '';
                    fenceHeightInput.value = inputValues.fenceHeight || '';
                    postSizeSelect.value = inputValues.postSize || '65';

                    if (inputValues.slidingGate) {
                        slidingGateYes.checked = true;
                    } else {
                        slidingGateNo.checked = true;
                    }
                    toggleInputs(slidingGateYes, slidingGateNo, slidingGateInputs);
                    slidingGateLengthInput.value = inputValues.slidingGateLength || '';

                    if (inputValues.gateMotor) {
                        gateMotorYes.checked = true;
                    } else {
                        gateMotorNo.checked = true;
                    }
                    toggleInputs(gateMotorYes, gateMotorNo, motorInputs);
                    motorTypeSelect.value = inputValues.motorType || '';
                    batteryBackupCheckbox.checked = inputValues.batteryBackup || false;
                    antennaCheckbox.checked = inputValues.antenna || false;
                    ziggyRemoteCheckbox.checked = inputValues.ziggyRemote || false;
                    // Ensure the ziggyRemoteQty input is enabled/disabled correctly based on loaded state
                    ziggyRemoteQtyInput.disabled = !ziggyRemoteCheckbox.checked;
                    ziggyRemoteQtyInput.value = inputValues.ziggyRemoteQty || '1';


                    if (inputValues.pedestrianGate) {
                        pedestrianGateYes.checked = true;
                    } else {
                        pedestrianGateNo.checked = true;
                    }
                    toggleInputs(pedestrianGateYes, pedestrianGateNo, pedestrianGateInputs);
                    pedestrianGateWidthInput.value = inputValues.pedestrianGateWidth || '';
                    hingeTypeSelect.value = inputValues.hingeType || 'Adjustable Hinges';
                    latchTypeSelect.value = inputValues.latchType || 'D latch';

                    // Populate advanced settings
                    profitSlidingGateMaterialInput.value = inputValues.profitSlidingGateMaterial || Math.round(DEFAULT_PROFIT_SLIDING_GATE_MATERIAL * 100);
                    profitPedestrianGateMaterialInput.value = inputValues.profitPedestrianGateMaterial || Math.round(DEFAULT_PROFIT_PEDESTRIAN_GATE_MATERIAL * 100);
                    profitPanelsMaterialInput.value = inputValues.profitPanelsMaterial || Math.round(DEFAULT_PROFIT_PANELS_MATERIAL * 100);
                    profitPostsMaterialInput.value = inputValues.profitPostsMaterial || Math.round(DEFAULT_PROFIT_POSTS_MATERIAL * 100);
                    profitCapsBracketsMaterialInput.value = inputValues.profitCapsBracketsMaterial || Math.round(DEFAULT_PROFIT_CAPS_BRACKETS_MATERIAL * 100);
                    profitPowderCoatingInput.value = inputValues.profitPowderCoating || Math.round(DEFAULT_PROFIT_POWDER_COATING * 100);
                    profitGateMotorsInput.value = inputValues.profitGateMotors || Math.round(DEFAULT_PROFIT_GATE_MOTORS * 100);
                    profitGateMotorHardwareInput.value = inputValues.profitGateMotorHardware || Math.round(DEFAULT_PROFIT_GATE_MOTOR_HARDWARE * 100);

                    installPostsFixedInput.value = inputValues.installPostsFixed || DEFAULT_INSTALL_POSTS_FIXED;
                    installSlidingGateFixedInput.value = inputValues.installSlidingGateFixed || DEFAULT_INSTALL_SLIDING_GATE_FIXED;
                    installPedestrianGateFixedInput.value = inputValues.installPedestrianGateFixed || DEFAULT_INSTALL_PEDESTRIAN_GATE_FIXED;
                    installPanelsPerMeterInput.value = inputValues.installPanelsPerMeter || DEFAULT_INSTALL_PANELS_PER_METER;
                    installMotorFixedInput.value = inputValues.installMotorFixed || DEFAULT_INSTALL_MOTOR_FIXED;

                    fabricationCostPerDayInput.value = inputValues.fabricationCostPerDay || DEFAULT_FABRICATION_COST_PER_DAY;
                    fabricationDaysPerJobInput.value = inputValues.fabricationDaysPerJob || DEFAULT_FABRICATION_DAYS_PER_JOB;

                    // Populate dynamic material costs
                    if (inputValues.materialCosts) {
                        for (const key in inputValues.materialCosts) {
                            const inputId = `material-${key.replace(/\s+/g, '-')}-cost`;
                            const inputElement = document.getElementById(inputId);
                            if (inputElement) {
                                inputElement.value = inputValues.materialCosts[key];
                            }
                        }
                    }

                    // Ensure all necessary UI updates triggered by toggles happen after setting values
                    toggleInputs(slidingGateYes, slidingGateNo, slidingGateInputs);
                    toggleInputs(pedestrianGateYes, pedestrianGateNo, pedestrianGateInputs);
                    toggleInputs(gateMotorYes, gateMotorNo, motorInputs);
                    ziggyRemoteQtyInput.disabled = !ziggyRemoteCheckbox.checked;

                    // Trigger a recalculation to update the displayed results based on loaded inputs
                    quoteForm.dispatchEvent(new Event('submit'));
                    closeLoadQuotesModal(); // Close the modal after loading

                    showMessageBox("Quote Loaded", `Quote "${selectedQuoteData.name}" loaded successfully.`);
                } else {
                    showMessageBox("Error", "Quote data not found or is incomplete.");
                }
            } catch (e) {
                console.error("Error loading quote:", e);
                showMessageBox("Error Loading", `Failed to load quote: ${e.message}`);
            }
        };

        /**
         * Shows the delete confirmation modal.
         * @param {string} id - The ID of the quote to delete.
         * @param {string} name - The name of the quote to delete.
         */
        window.showDeleteConfirmModal = function(id, name) {
            quoteToDeleteId = id;
            document.getElementById('deleteConfirmMessage').textContent = `Are you sure you want to delete the quote "${name}"? This action cannot be undone.`;
            document.getElementById('deleteConfirmModal').style.display = 'block';
            overlay.style.display = 'block';
        };

        /**
         * Confirms and performs the delete action.
         */
        window.confirmDelete = function() {
            closeDeleteConfirmModal();
            if (!quoteToDeleteId) {
                showMessageBox("Error", "No quote selected for deletion.");
                return;
            }

            try {
                let savedQuotes = JSON.parse(localStorage.getItem(QUOTES_STORAGE_KEY) || '[]');
                const originalLength = savedQuotes.length;
                savedQuotes = savedQuotes.filter(quote => quote.id !== quoteToDeleteId);

                if (savedQuotes.length < originalLength) {
                    localStorage.setItem(QUOTES_STORAGE_KEY, JSON.stringify(savedQuotes));
                    showMessageBox("Quote Deleted", "Quote has been deleted successfully.");
                    loadSavedQuotes(); // Refresh the list
                } else {
                    showMessageBox("Not Found", "Quote not found in local storage.");
                }
            } catch (e) {
                console.error("Error deleting quote from local storage:", e);
                showMessageBox("Error Deleting", `Failed to delete quote: ${e.message}`);
            } finally {
                quoteToDeleteId = null; // Clear the temporary storage
            }
        };

        /**
         * Closes the delete confirmation modal.
         */
        window.closeDeleteConfirmModal = function() {
            document.getElementById('deleteConfirmModal').style.display = 'none';
            if (messageBox.style.display === 'none' && loadQuotesModal.style.display === 'none') {
                overlay.style.display = 'none';
            }
            quoteToDeleteId = null; // Clear on close
        };

        // --- End Local Storage Quote Management ---


        /**
         * Displays a custom message box instead of using alert().
         * @param {string} title - The title of the message box.
         * @param {string} message - The content message.
         */
        function showMessageBox(title, message) {
            messageBoxTitle.textContent = title;
            messageBoxContent.textContent = message;
            messageBox.style.display = 'block';
            overlay.style.display = 'block';
        }

        /**
         * Closes the custom message box.
         */
        window.closeMessageBox = function() { // Made global
            messageBox.style.display = 'none';
            // Only hide overlay if no other modals are open
            if (loadQuotesModal.style.display === 'none' && document.getElementById('deleteConfirmModal').style.display === 'none') {
                 overlay.style.display = 'none';
            }
        }

        /**
         * Displays the Load Quotes modal.
         */
        window.showLoadQuotesModal = function() { // Made global
            loadQuotesModal.style.display = 'block';
            overlay.style.display = 'block';
            loadSavedQuotes(); // Load quotes every time the modal is opened
        }

        /**
         * Closes the Load Quotes modal.
         */
        window.closeLoadQuotesModal = function() { // Made global
            loadQuotesModal.style.display = 'none';
             // Only hide overlay if no other modals are open
            if (messageBox.style.display === 'none' && document.getElementById('deleteConfirmModal').style.display === 'none') {
                overlay.style.display = 'none';
            }
        }

        /**
         * Prints the professional quote summary.
         */
        window.printQuoteSummary = function() {
            const customerName = customerNameInput.value.trim();
            const quoteSummaryElement = document.getElementById('professionalQuoteSummary');
            if (quoteSummaryElement.classList.contains('hidden')) {
                showMessageBox("No Quote Summary", "Please calculate a quote first to generate a summary for printing.");
                return;
            }

            // Create a temporary print window
            const printWindow = window.open('', '_blank');
            printWindow.document.write('<html><head><title>Fencing Quote</title>');
            // Include Tailwind CSS for styling in the print preview
            printWindow.document.write('<script src="https://cdn.tailwindcss.com"><\/script>');
            // Include the custom print styles from the main page
            printWindow.document.write('<style>');
            printWindow.document.write(document.querySelector('style').innerHTML); // Copy all styles
            printWindow.document.write('</style>');
            printWindow.document.write('</head><body>');

            // Create a div to hold the content for printing and apply the print-container class
            printWindow.document.write('<div class="print-container">');

            // Add the customer name to the printed summary
            if (customerName) {
                printWindow.document.write(`<h2 class="text-center mb-6">Quote for ${customerName}</h2>`);
            } else {
                 printWindow.document.write(`<h2 class="text-center mb-6">Quote Summary</h2>`);
            }

            // Copy the current content of the quote summary items and total
            printWindow.document.write(quoteSummaryItemsDiv.innerHTML);
            printWindow.document.write('<div class="final-total">Quote Total: ' + finalProfessionalQuoteTotalSpan.outerHTML + '</div>');

            printWindow.document.write('</div>'); // Close print-container
            printWindow.document.write('</body></html>');
            printWindow.document.close();

            // Wait for content to render, then print
            printWindow.onload = function() {
                printWindow.focus();
                printWindow.print();
                // Close the window after printing (optional, can be annoying)
                // printWindow.close();
            };
        };


        /**
         * Toggles the visibility of input fields based on radio button selection.
         * @param {HTMLElement} radioYes - The 'Yes' radio button element.
         * @param {HTMLElement} radioNo - The 'No' radio button element.
         * @param {HTMLElement} inputContainer - The container holding the related input fields.
         */
        function toggleInputs(radioYes, radioNo, inputContainer) {
            if (radioYes.checked) {
                inputContainer.classList.remove('hidden');
            } else {
                inputContainer.classList.add('hidden');
                // Clear inputs when hidden
                Array.from(inputContainer.querySelectorAll('input[type="number"], select, input[type="checkbox"]')).forEach(input => {
                    if (input.type === 'number') input.value = '';
                    else if (input.tagName === 'SELECT') {
                        input.selectedIndex = 0;
                    } else if (input.type === 'checkbox') {
                        input.checked = false;
                    }
                });
                // Specifically handle ziggyRemoteQty input if it becomes disabled
                if (inputContainer.contains(ziggyRemoteQtyInput)) {
                     ziggyRemoteQtyInput.disabled = true;
                     ziggyRemoteQtyInput.value = 1;
                }
            }
        }

        // Add event listeners for radio buttons to toggle input visibility
        slidingGateYes.addEventListener('change', () => toggleInputs(slidingGateYes, slidingGateNo, slidingGateInputs));
        slidingGateNo.addEventListener('change', () => toggleInputs(slidingGateYes, slidingGateNo, slidingGateInputs));
        pedestrianGateYes.addEventListener('change', () => toggleInputs(pedestrianGateYes, pedestrianGateNo, pedestrianGateInputs));
        pedestrianGateNo.addEventListener('change', () => toggleInputs(pedestrianGateYes, pedestrianGateNo, pedestrianGateInputs));

        // Add event listeners for Gate Motor radio buttons and Ziggy Remote checkbox
        gateMotorYes.addEventListener('change', () => toggleInputs(gateMotorYes, gateMotorNo, motorInputs));
        gateMotorNo.addEventListener('change', () => toggleInputs(gateMotorYes, gateMotorNo, motorInputs));

        ziggyRemoteCheckbox.addEventListener('change', function() {
            ziggyRemoteQtyInput.disabled = !this.checked;
            if (!this.checked) {
                ziggyRemoteQtyInput.value = 1; // Reset quantity if unchecked
            }
        });

        /**
         * Generic function to toggle collapsible sections.
         * @param {HTMLElement} toggleBtn - The button that triggers the toggle.
         */
        function toggleCollapsibleSection(toggleBtn) {
            const targetId = toggleBtn.dataset.target;
            const contentDiv = document.getElementById(targetId);
            const iconSpan = toggleBtn.querySelector('.toggle-icon');

            // Add a null check here to prevent errors if contentDiv is null
            if (!contentDiv) {
                console.error(`Collapsible content div with ID '${targetId}' not found.`);
                return; // Exit the function if the element is not found
            }

            if (contentDiv.classList.contains('expanded')) {
                contentDiv.classList.remove('expanded');
                iconSpan.classList.remove('rotate');
            } else {
                contentDiv.classList.add('expanded');
                iconSpan.classList.add('rotate');
            }
        }

        // Event listener for Advanced Settings toggle
        toggleAdvancedSettingsBtn.addEventListener('click', () => {
            toggleCollapsibleSection(toggleAdvancedSettingsBtn);
        });

        // Live update for auto-calculated post length
        fenceHeightInput.addEventListener('input', updateCalculatedPostLength);

        function updateCalculatedPostLength() {
            const fenceHeight = parseFloat(fenceHeightInput.value) || 0;
            const calculatedLength = fenceHeight + 600;
        }

        // Live update for fence panel info based on boundary and gate lengths
        overallBoundaryLengthInput.addEventListener('input', updateFencePanelInfo);
        slidingGateLengthInput.addEventListener('input', updateFencePanelInfo);
        pedestrianGateWidthInput.addEventListener('input', updateFencePanelInfo);
        slidingGateYes.addEventListener('change', updateFencePanelInfo);
        slidingGateNo.addEventListener('change', updateFencePanelInfo);
        pedestrianGateYes.addEventListener('change', updateFencePanelInfo);
        pedestrianGateNo.addEventListener('change', updateFencePanelInfo);

        /**
         * Calculates and updates the displayed fence panel information.
         * This function is triggered by input changes to provide live feedback.
         */
        function updateFencePanelInfo() {
            const overallBoundaryLength = parseFloat(overallBoundaryLengthInput.value) || 0;
            let currentLinearFenceLength = overallBoundaryLength;
            const sGateLength = slidingGateYes.checked ? (parseFloat(slidingGateLengthInput.value) || 0) : 0;
            const pGateWidth = pedestrianGateYes.checked ? (parseFloat(pedestrianGateWidthInput.value) || 0) : 0;

            currentLinearFenceLength -= (sGateLength + pGateWidth);

            if (currentLinearFenceLength < 0) {
                displayNumPanels.classList.add('hidden');
                displayPanelLength.classList.add('hidden');
                displayFenceLinearLength.classList.add('hidden');
                panelHint.classList.remove('hidden');
                panelHint.textContent = "Combined gate lengths exceed overall boundary.";
                return;
            }

            if (currentLinearFenceLength > 0 && overallBoundaryLength > 0) {
                panelHint.classList.add('hidden');
                displayNumPanels.classList.remove('hidden');
                displayPanelLength.classList.remove('hidden');
                displayFenceLinearLength.classList.remove('hidden');

                const { numPanels, individualPanelLengths } = calculatePanelDistribution(currentLinearFenceLength);
                const panelDisplayString = getPanelDisplayString(individualPanelLengths, IDEAL_PANEL_2_4M);

                displayNumPanels.querySelector('span').textContent = numPanels;
                displayPanelLength.querySelector('span').textContent = panelDisplayString;
                displayFenceLinearLength.querySelector('span').textContent = `${currentLinearFenceLength.toFixed(0)}mm`;

            } else {
                displayNumPanels.classList.add('hidden');
                displayPanelLength.classList.add('hidden');
                displayFenceLinearLength.classList.add('hidden');
                panelHint.classList.remove('hidden');
                panelHint.textContent = "Enter overall boundary length to calculate panels.";
            }
        }


        /**
         * Calculates the number of full stock units needed for a given length of material.
         * @param {number} requiredLength - The total length of material required in mm.
         * @param {number} unitLength - The length of one stock unit in mm.
         * @returns {number} The number of stock units (rounded up).
         */
        function calculateUnitsNeeded(requiredLength, unitLength) {
            if (requiredLength <= 0 || unitLength <= 0) return 0;
            return Math.ceil(requiredLength / unitLength);
        }

        /**
         * Helper function to format material output HTML for the new multi-line format.
         * @param {string} name - Name of the material.
         * @param {number} displayAmount - Quantity or number of lengths.
         * @param {string} unitType - Unit type (e.g., 'pcs', 'x 8000mm lengths').
         * @param {number} rawCost - Base cost of the material before profit.
         * @param {number} profitIncludedCost - Cost of the material including profit.
         * @returns {string} HTML string for the material line item.
         */
        function formatLineItem(name, displayAmount, unitType, rawCost, profitIncludedCost) {
            return `
                <div class="material-line-item">
                    <div class="item-name">${name}:</div>
                    <div class="item-qty-unit">${displayAmount} ${unitType}</div>
                    <div class="item-cost">
                        $${profitIncludedCost.toFixed(2)}
                        <span class="base-cost-display">($${rawCost.toFixed(2)} base)</span>
                    </div>
                </div>
            `;
        }

        /**
         * Helper function to format a professional quote line item.
         * @param {string} description - The text description of the line item.
         * @param {number} price - The total price for this line item.
         * @returns {string} HTML string for the professional quote line item.
         */
        function formatProfessionalQuoteLineItem(description, price) {
            return `
                <div class="quote-line-item">
                    <span class="item-description">${description}</span>
                    <span class="item-price">$${price.toFixed(2)}</span>
                </div>
            `;
        }


        /**
         * Calculates the individual panel lengths based on total linear fence length,
         * ensuring all panels are exactly 2.4m, except for the last one which takes the remainder.
         * @param {number} linearFenceLength - The total length available for fence panels.
         * @returns {{numPanels: number, averagePanelLength: number, individualPanelLengths: number[]}}
         */
        function calculatePanelDistribution(linearFenceLength) {
            const individualPanelLengths = [];
            const IDEAL_PANEL_2_4M = 2400;

            if (linearFenceLength <= 0) {
                return { numPanels: 0, averagePanelLength: 0, individualPanelLengths: [] };
            }

            // Calculate how many full 2.4m panels fit
            let numFullPanels = Math.floor(linearFenceLength / IDEAL_PANEL_2_4M);
            let remainder = linearFenceLength % IDEAL_PANEL_2_4M;

            // Add all full 2.4m panels
            for (let i = 0; i < numFullPanels; i++) {
                individualPanelLengths.push(IDEAL_PANEL_2_4M);
            }

            // If there's a remainder, add it as the last panel
            if (remainder > 0) {
                individualPanelLengths.push(remainder);
            }

            const numPanels = individualPanelLengths.length;
            const totalLengthCalculated = individualPanelLengths.reduce((sum, length) => sum + length, 0);
            const averagePanelLength = numPanels > 0 ? (totalLengthCalculated / numPanels) : 0;

            return { numPanels, averagePanelLength, individualPanelLengths };
        }

        /**
         * Generates the display string for panel lengths (e.g., "5 x 2400mm, 1 x 600mm").
         * @param {number[]} panelsArray - An array of individual panel lengths.
         * @param {number} idealPanelLength - The standard ideal panel length (e.g., 2400).
         * @returns {string} The formatted string.
         */
        function getPanelDisplayString(panelsArray, idealPanelLength) {
            if (!panelsArray || panelsArray.length === 0) {
                return 'N/A';
            }

            let fullPanelCount = 0;
            let lastPanelLength = 0;

            // Count full ideal panels
            for (let i = 0; i < panelsArray.length; i++) {
                // Use a small epsilon for floating point comparison
                if (Math.abs(panelsArray[i] - idealPanelLength) < 0.1) { // within 0.1mm
                    fullPanelCount++;
                }
            }

            // The last panel is potentially the remainder, check if it's different from ideal
            if (panelsArray.length > 0 && Math.abs(panelsArray[panelsArray.length - 1] - idealPanelLength) >= 0.1) {
                lastPanelLength = panelsArray[panelsArray.length - 1];
            }

            let displayString = '';
            if (fullPanelCount > 0) {
                displayString += `${fullPanelCount} x ${idealPanelLength}mm`;
            }
            // Add the last panel only if it's a remainder and different from the ideal panel length
            if (lastPanelLength > 0) {
                if (displayString !== '') {
                    displayString += `, `;
                }
                displayString += `1 x ${lastPanelLength.toFixed(0)}mm`;
            }
            // Edge case: if there's only one panel and it's not a full ideal length (e.g., total length 1000mm)
            if (displayString === '' && panelsArray.length === 1 && panelsArray[0] > 0) {
                 displayString = `1 x ${panelsArray[0].toFixed(0)}mm`;
            } else if (displayString === '' && panelsArray.length === 0) {
                displayString = 'N/A'; // Should not happen if linearFenceLength > 0
            }


            return displayString;
        }

        /**
         * Draws the bird's eye view of the fence layout on the canvas.
         * @param {object} layoutData - Object containing dimensions and layout elements.
         */
        function drawFenceLayout(layoutData) {
            ctx.clearRect(0, 0, fenceLayoutCanvas.width, fenceLayoutCanvas.height); // Clear canvas

            const canvasWidth = fenceLayoutCanvas.width;
            const canvasHeight = fenceLayoutCanvas.height;
            const padding = 20; // Padding from canvas edges
            const fenceLineY = canvasHeight / 2;
            const postSizePx = 8; // Visual size of a post marker, slightly larger for clarity
            const textOffset = 25; // Vertical offset for text labels above segments

            // Calculate scale: 1 pixel represents how many mm?
            const drawingAreaWidth = canvasWidth - (2 * padding);
            const scale = drawingAreaWidth / layoutData.overallLength; // mm per pixel

            if (layoutData.overallLength <= 0 || !isFinite(scale)) {
                 ctx.fillStyle = '#ef4444';
                 ctx.font = '14px Inter';
                 ctx.fillText('Enter positive boundary length for drawing.', padding, fenceLineY);
                 return;
             }

            let currentX = padding; // Starting X position for drawing

            // Function to draw a segment (gate or panel)
            const drawSegment = (startX, length, type, color, label) => {
                const segmentWidthPx = length * scale;
                const endX = startX + segmentWidthPx;

                // Draw segment rectangle
                ctx.fillStyle = color;
                ctx.fillRect(startX, fenceLineY - 10, segmentWidthPx, 20); // Wider for better visibility
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 1;
                ctx.strokeRect(startX, fenceLineY - 10, segmentWidthPx, 20);

                // Add text label
                ctx.fillStyle = '#1f2937';
                ctx.font = '14px Inter'; // Slightly larger font for readability

                let displayLabel = '';
                if (type === 'sliding-gate') {
                    displayLabel = `Sliding Gate (${length.toFixed(0)})`;
                } else if (type === 'pedestrian-gate') {
                    displayLabel = `PA (${length.toFixed(0)})`;
                } else {
                    displayLabel = label; // Fallback
                }

                const textWidth = ctx.measureText(displayLabel).width;
                // Position text centered horizontally above the segment
                ctx.fillText(displayLabel, startX + (segmentWidthPx / 2) - (textWidth / 2), fenceLineY - textOffset);

                return endX;
            };

            // Function to draw a post
            const drawPost = (x, isSlidingExtra = false) => {
                ctx.fillStyle = isSlidingExtra ? '#FFD700' : '#4b5563'; // Gold for extra sliding post
                ctx.fillRect(x - (postSizePx / 2), fenceLineY - (postSizePx / 2), postSizePx, postSizePx);
                ctx.strokeStyle = '#374151';
                ctx.lineWidth = 1;
                ctx.strokeRect(x - (postSizePx / 2), fenceLineY - (postSizePx / 2), postSizePx, postSizePx);
            };

            // Draw initial post if overall length > 0
            if (layoutData.overallLength > 0) {
                drawPost(currentX); // Post at the very beginning of the boundary
            }

            // Draw Sliding Gate if present
            if (layoutData.slidingGate.present && layoutData.slidingGate.length > 0) {
                currentX = drawSegment(currentX, layoutData.slidingGate.length, 'sliding-gate', '#60a5fa', 'Sliding Gate');
                drawPost(currentX); // Post at the end of the sliding gate segment
                // Draw the third sliding gate post 150mm behind the previous post (visually for demonstration)
                // Ensure this extra post is within the overall layout bounds for drawing
                const extraPostX = currentX + (150 * scale);
                if (extraPostX < canvasWidth - padding) { // Only draw if it fits on canvas
                    drawPost(extraPostX, true); // Mark as special
                }
            }

            // Draw Pedestrian Gate if present
            if (layoutData.pedestrianGate.present && layoutData.pedestrianGate.width > 0) {
                currentX = drawSegment(currentX, layoutData.pedestrianGate.width, 'pedestrian-gate', '#818cf8', 'Pedestrian Gate');
                drawPost(currentX); // Post at the end of the pedestrian gate segment
            }

            // Draw Fence Panels
            if (layoutData.panels.present && layoutData.panels.individualPanelLengths.length > 0) {
                layoutData.panels.individualPanelLengths.forEach((panelLength, index) => {
                    currentX = drawSegment(currentX, panelLength, 'panel', '#d1d5db', `Panel ${index + 1}`);
                    drawPost(currentX); // Post at the end of each panel
                });
            }
        }


        /**
         * Main function to calculate the fencing quote.
         * @param {Event} event - The form submission event.
         */
        quoteForm.addEventListener('submit', function (event) {
            event.preventDefault(); // Prevent default form submission

            // Save settings before calculation and displaying results
            saveSettings();

            // Hide previous results and errors and clear content
            resultsDiv.classList.add('hidden');
            professionalQuoteSummaryDiv.classList.add('hidden'); // Hide professional summary
            quoteSummaryItemsDiv.innerHTML = ''; // Clear professional summary items
            customerNameDisplay.textContent = ''; // Clear customer name display


            // Get all collapsible content areas and hide them (collapse)
            document.querySelectorAll('.collapsible-content').forEach(content => {
                content.classList.remove('expanded');
            });
            // Reset all toggle icons to un-rotated state
            document.querySelectorAll('.toggle-icon').forEach(icon => {
                icon.classList.remove('rotate');
            });

            // Hide all result sections initially
            postsSection.classList.add('hidden');
            slidingGateSection.classList.add('hidden');
            pedestrianGateSection.classList.add('hidden');
            fencePanelsSection.classList.add('hidden');
            powderCoatingSection.classList.add('hidden');
            slidingGateFittingsSection.classList.add('hidden');
            gateMotorsSection.classList.add('hidden');
            installationCostsSection.classList.add('hidden');
            fabricationCostsSection.classList.add('hidden');


            postsMaterialsDiv.innerHTML = '';
            slidingGateMaterialsDiv.innerHTML = '';
            pedestrianGateMaterialsDiv.innerHTML = '';
            fencePanelsMaterialsDiv.innerHTML = ''; // Clear only the dynamic material list
            powderCoatingDetailsDiv.innerHTML = '';
            slidingGateFittingsMaterialsDiv.innerHTML = '';
            gateMotorsMaterialsDiv.innerHTML = '';
            installationDetailsDiv.innerHTML = '';
            fabricationDetailsDiv.innerHTML = '';
            ctx.clearRect(0, 0, fenceLayoutCanvas.width, fenceLayoutCanvas.height); // Clear canvas

            // Reset panel info display
            displayNumPanels.classList.add('hidden'); // Original hidden ones (these are in the input section)
            displayPanelLength.classList.add('hidden');
            displayFenceLinearLength.classList.add('hidden');
            panelHint.classList.remove('hidden');
            panelHint.textContent = "Enter overall boundary length to calculate panels.";
            displayNumPanelsActual.textContent = '0'; // Clear new display elements too
            displayPanelLengthActual.textContent = '0mm';
            displayFenceLinearLengthActual.textContent = '0mm';


            // Read dynamic profit margins and installation costs from inputs
            const currentProfitMargins = {
                PROFIT_SLIDING_GATE_MATERIAL: (parseFloat(profitSlidingGateMaterialInput.value) / 100) || DEFAULT_PROFIT_SLIDING_GATE_MATERIAL,
                PROFIT_PEDESTRIAN_GATE_MATERIAL: (parseFloat(profitPedestrianGateMaterialInput.value) / 100) || DEFAULT_PROFIT_PEDESTRIAN_GATE_MATERIAL,
                PROFIT_PANELS_MATERIAL: (parseFloat(profitPanelsMaterialInput.value) / 100) || DEFAULT_PROFIT_PANELS_MATERIAL,
                PROFIT_POSTS_MATERIAL: (parseFloat(profitPostsMaterialInput.value) / 100) || DEFAULT_PROFIT_POSTS_MATERIAL, // New profit margin
                PROFIT_CAPS_BRACKETS_MATERIAL: (parseFloat(profitCapsBracketsMaterialInput.value) / 100) || DEFAULT_PROFIT_CAPS_BRACKETS_MATERIAL, // New profit margin
                PROFIT_POWDER_COATING: (parseFloat(profitPowderCoatingInput.value) / 100) || DEFAULT_PROFIT_POWDER_COATING,
                PROFIT_GATE_MOTORS: (parseFloat(profitGateMotorsInput.value) / 100) || DEFAULT_PROFIT_GATE_MOTORS,
                PROFIT_GATE_MOTOR_HARDWARE: (parseFloat(profitGateMotorHardwareInput.value) / 100) || DEFAULT_PROFIT_GATE_MOTOR_HARDWARE,
            };

            const currentInstallationCosts = {
                INSTALL_POSTS_FIXED: parseFloat(installPostsFixedInput.value) || DEFAULT_INSTALL_POSTS_FIXED,
                INSTALL_SLIDING_GATE_FIXED: parseFloat(installSlidingGateFixedInput.value) || DEFAULT_INSTALL_SLIDING_GATE_FIXED,
                INSTALL_PEDESTRIAN_GATE_FIXED: parseFloat(installPedestrianGateFixedInput.value) || DEFAULT_INSTALL_PEDESTRIAN_GATE_FIXED,
                INSTALL_PANELS_PER_METER: parseFloat(installPanelsPerMeterInput.value) || DEFAULT_INSTALL_PANELS_PER_METER,
                INSTALL_MOTOR_FIXED: parseFloat(installMotorFixedInput.value) || DEFAULT_INSTALL_MOTOR_FIXED, // Get new motor install cost
            };

            const currentFabricationCosts = {
                FABRICATION_COST_PER_DAY: parseFloat(fabricationCostPerDayInput.value) || DEFAULT_FABRICATION_COST_PER_DAY,
                FABRICATION_DAYS_PER_JOB: parseFloat(fabricationDaysPerJobInput.value) || DEFAULT_FABRICATION_DAYS_PER_JOB,
            };

            // Read dynamic material costs from the new inputs
            const currentMaterialPriceList = {};
            for (const key in defaultMaterialPriceList) {
                const inputId = `material-${key.replace(/\s+/g, '-')}-cost`;
                const inputElement = document.getElementById(inputId);
                // Use the value from the input if available, otherwise fall back to the default
                currentMaterialPriceList[key] = {
                    pricePerUnit: parseFloat(inputElement.value) || defaultMaterialPriceList[key].pricePerUnit,
                    unitLength: defaultMaterialPriceList[key].unitLength // unitLength remains fixed
                };
            }


            // Initialize quote sections with specific cost categories
            let quoteSections = {
                posts: { materialCost: 0, materialsBreakdown: [], numCalculated: 0, length: 0 },
                slidingGate: { materialCost: 0, materialsBreakdown: [], totalFrameLength: 0, present: false, length: 0 },
                slidingGateFittings: { materialCost: 0, materialsBreakdown: [], present: false },
                gateMotors: { motorMaterialCost: 0, motorBreakdown: [], hardwareMaterialCost: 0, hardwareBreakdown: [], present: false },
                pedestrianGate: { materialCost: 0, materialsBreakdown: [], totalFrameLength: 0, present: false, width: 0, hingeType: '', latchType: '' },
                fencePanels: { materialCost: 0, materialsBreakdown: [], totalLength: 0, numPanels: 0, individualPanelLengths: [], present: false },
                powderCoating: { baseCost: 0, breakdown: [] }, // baseCost will now store profit-included cost
                fabrication: { baseCost: 0, breakdown: [] }, // Initialize fabrication with breakdown array
                totalMaterialCostWithProfit: 0, // This will be the sum of all material costs including their respective profits
                totalInstallationCost: 0,
                totalFabricationCost: 0
            };
            let errors = [];

            // Get fence height for auto-calculation of post length
            const fenceHeight = parseFloat(fenceHeightInput.value);
            const postSize = parseInt(postSizeSelect.value);

            // Auto-calculate post length
            const calculatedPostLength = fenceHeight + 600;
            if (isNaN(calculatedPostLength) || calculatedPostLength <= 600) {
                 errors.push("Please enter a valid Fence Height (mm) to calculate post length.");
            } else {
                quoteSections.posts.length = calculatedPostLength;
            }


            // --- Sliding Gate Dimensions & Check ---
            let sGateLength = 0;
            if (slidingGateYes.checked) {
                sGateLength = parseFloat(slidingGateLengthInput.value);
                if (isNaN(sGateLength) || sGateLength <= 0) errors.push("Please enter a valid Sliding Gate Length.");
                if (errors.length === 0) {
                    quoteSections.slidingGate.present = true;
                    quoteSections.slidingGate.length = sGateLength;
                    quoteSections.slidingGateFittings.present = true; // If sliding gate is present, fittings are also present
                }
            }

            // --- Gate Motor Calculation & Check ---
            let motorInstallCostForSummary = 0; // Capture for professional quote summary
            if (gateMotorYes.checked) {
                const motorType = motorTypeSelect.value;
                if (!motorType) errors.push("Please select a Gate Motor Type.");

                if (errors.length === 0) { // Proceed only if motor type is selected
                    quoteSections.gateMotors.present = true;
                    // Use currentMaterialPriceList for motor info
                    const motorInfo = currentMaterialPriceList[motorType];
                    if (motorInfo) {
                        const rawMotorCost = motorInfo.pricePerUnit;
                        const motorCostWithProfit = rawMotorCost * (1 + currentProfitMargins.PROFIT_GATE_MOTORS);
                        quoteSections.gateMotors.motorMaterialCost += motorCostWithProfit;
                        quoteSections.gateMotors.motorBreakdown.push({
                            name: motorType,
                            displayAmount: 1,
                            unitType: 'unit',
                            cost: motorCostWithProfit,
                            rawCost: rawMotorCost // Store raw cost
                        });
                        quoteSections.totalMaterialCostWithProfit += motorCostWithProfit;
                    } else {
                        errors.push(`Price information for ${motorType} not found.`);
                    }

                    // Gear Rack
                    if (quoteSections.slidingGate.present && quoteSections.slidingGate.length > 0) {
                        // Use currentMaterialPriceList for gear rack info
                        const gearRackInfo = currentMaterialPriceList['Gear rack'];
                        if (gearRackInfo) {
                            const requiredRackLengthMM = quoteSections.slidingGate.length; // 1m per meter of gate
                            const rackUnitsNeeded = calculateUnitsNeeded(requiredRackLengthMM, gearRackInfo.unitLength);
                            const rawCostOfRack = rackUnitsNeeded * gearRackInfo.pricePerUnit;
                            const costOfRackWithProfit = rawCostOfRack * (1 + currentProfitMargins.PROFIT_GATE_MOTOR_HARDWARE);
                            quoteSections.gateMotors.hardwareMaterialCost += costOfRackWithProfit;
                            quoteSections.gateMotors.hardwareBreakdown.push({
                                name: 'Gear rack',
                                displayAmount: rackUnitsNeeded,
                                unitType: `x ${gearRackInfo.unitLength/1000}m lengths (Total ${requiredRackLengthMM.toFixed(0)}mm)`,
                                cost: costOfRackWithProfit,
                                rawCost: rawCostOfRack // Store raw cost
                            });
                            quoteSections.totalMaterialCostWithProfit += costOfRackWithProfit;
                        } else {
                            errors.push('Price information for Gear rack not found.');
                        }
                    } else {
                        // Removed the error, as sliding gate is optional
                        // errors.push("Sliding Gate Length is required for Gear rack calculation when a motor is selected.");
                    }

                    // Battery backup
                    if (batteryBackupCheckbox.checked) {
                        // Use currentMaterialPriceList for battery info
                        const batteryInfo = currentMaterialPriceList['Battery backup'];
                        if (batteryInfo) {
                            const rawBatteryCost = batteryInfo.pricePerUnit;
                            const batteryCostWithProfit = rawBatteryCost * (1 + currentProfitMargins.PROFIT_GATE_MOTOR_HARDWARE);
                            quoteSections.gateMotors.hardwareMaterialCost += batteryCostWithProfit;
                            quoteSections.gateMotors.hardwareBreakdown.push({
                                name: 'Battery backup',
                                displayAmount: 1,
                                unitType: 'pcs',
                                cost: batteryCostWithProfit,
                                rawCost: rawBatteryCost // Store raw cost
                            });
                            quoteSections.totalMaterialCostWithProfit += batteryCostWithProfit;
                        } else {
                            errors.push('Price information for Battery backup not found.');
                        }
                    }

                    // Antenna
                    if (antennaCheckbox.checked) {
                        // Use currentMaterialPriceList for antenna info
                        const antennaInfo = currentMaterialPriceList['Antenna'];
                        if (antennaInfo) {
                            const rawAntennaCost = antennaInfo.pricePerUnit;
                            const antennaCostWithProfit = rawAntennaCost * (1 + currentProfitMargins.PROFIT_GATE_MOTOR_HARDWARE);
                            quoteSections.gateMotors.hardwareMaterialCost += antennaCostWithProfit;
                            quoteSections.gateMotors.hardwareBreakdown.push({
                                name: 'Antenna',
                                displayAmount: 1,
                                unitType: 'pcs',
                                cost: antennaCostWithProfit,
                                rawCost: rawAntennaCost // Store raw cost
                            });
                            quoteSections.totalMaterialCostWithProfit += antennaCostWithProfit;
                        } else {
                            errors.push('Price information for Antenna not found.');
                        }
                    }

                    // Ziggy Remote
                    if (ziggyRemoteCheckbox.checked) {
                        const ziggyRemoteQty = parseInt(ziggyRemoteQtyInput.value) || 1;
                        // Use currentMaterialPriceList for ziggy remote info
                        const ziggyRemoteInfo = currentMaterialPriceList['Ziggy Remote'];
                        if (ziggyRemoteInfo) {
                            const rawZiggyRemoteCost = ziggyRemoteQty * ziggyRemoteInfo.pricePerUnit;
                            const ziggyRemoteCostWithProfit = rawZiggyRemoteCost * (1 + currentProfitMargins.PROFIT_GATE_MOTOR_HARDWARE);
                            quoteSections.gateMotors.hardwareMaterialCost += ziggyRemoteCostWithProfit;
                            quoteSections.gateMotors.hardwareBreakdown.push({
                                name: 'Ziggy Remote',
                                displayAmount: ziggyRemoteQty,
                                unitType: 'pcs',
                                cost: ziggyRemoteCostWithProfit,
                                rawCost: rawZiggyRemoteCost // Store raw cost
                            });
                            quoteSections.totalMaterialCostWithProfit += ziggyRemoteCostWithProfit;
                        } else {
                            errors.push('Price information for Ziggy Remote not found.');
                        }
                    }

                    // Add motor installation cost
                    quoteSections.totalInstallationCost += currentInstallationCosts.INSTALL_MOTOR_FIXED;
                    motorInstallCostForSummary = currentInstallationCosts.INSTALL_MOTOR_FIXED; // Capture for summary
                }
            }


            // --- Pedestrian Gate Dimensions & Check ---
            let pGateWidth = 0;
            let hingeType = '';
            let latchType = '';

            if (pedestrianGateYes.checked) {
                pGateWidth = parseFloat(pedestrianGateWidthInput.value);
                hingeType = hingeTypeSelect.value;
                latchType = latchTypeSelect.value;

                if (isNaN(pGateWidth) || pGateWidth <= 0) errors.push("Please enter a valid Pedestrian Gate Width.");
                if (errors.length === 0) {
                    quoteSections.pedestrianGate.present = true;
                    quoteSections.pedestrianGate.width = pGateWidth;
                    quoteSections.pedestrianGate.hingeType = hingeType;
                    quoteSections.pedestrianGate.latchType = latchType;
                }
            }

            // --- Fence Panels Calculation (based on overall boundary) ---
            const overallBoundaryLength = parseFloat(overallBoundaryLengthInput.value);
            let linearFenceLength = 0; // This is the length remaining for fence panels

            if (isNaN(overallBoundaryLength) || overallBoundaryLength <= 0) {
                errors.push("Please enter a valid Overall Boundary Length (mm) to calculate panels.");
            } else {
                linearFenceLength = overallBoundaryLength;

                if (quoteSections.slidingGate.present && !isNaN(sGateLength)) {
                    linearFenceLength -= sGateLength;
                }
                if (quoteSections.pedestrianGate.present && !isNaN(pGateWidth)) {
                    linearFenceLength -= pGateWidth;
                }

                if (linearFenceLength < 0) {
                    errors.push("Combined gate lengths exceed the overall boundary length. Please adjust inputs.");
                } else if (linearFenceLength > 0) {
                    quoteSections.fencePanels.present = true;
                    quoteSections.fencePanels.totalLength = linearFenceLength;

                    // Changed to directly assign from the returned object to avoid potential ReferenceError
                    const calculatedPanelData = calculatePanelDistribution(linearFenceLength);
                    quoteSections.fencePanels.numPanels = calculatedPanelData.numPanels;
                    quoteSections.fencePanels.individualPanelLengths = calculatedPanelData.individualPanelLengths;
                }
            }


            // Display errors if any validation failed before proceeding with final calculations
            if (errors.length > 0) {
                showMessageBox("Input Error", errors.map(err => `• ${err}`).join('<br/>')); // Use message box for errors
                return;
            }


            // --- Automated Post Calculation ---
            let calculatedNumPosts = 0;
            if (overallBoundaryLength > 0) {
                calculatedNumPosts = 1; // Start with one post at the very beginning of the boundary
                if (quoteSections.slidingGate.present) {
                    calculatedNumPosts += 1; // Post at the end of the sliding gate segment
                    calculatedNumPosts += 1; // The extra third post for slider (150mm behind)
                }
                if (quoteSections.pedestrianGate.present) {
                    calculatedNumPosts += 1; // Post at the end of the pedestrian gate segment
                }
                if (quoteSections.fencePanels.present) {
                    calculatedNumPosts += quoteSections.fencePanels.numPanels; // One post at the end of each panel segment
                }
            }
            quoteSections.posts.numCalculated = calculatedNumPosts;


            // --- Post Material Calculation ---
            let powderCoatingCostForPostsWithProfit = 0; // Initialize
            let totalPostsCost = 0; // For professional quote summary

            if (quoteSections.posts.numCalculated > 0 && quoteSections.posts.length > 0) {
                const postTypeName = `${postSize}x${postSize} Post`;
                // Use currentMaterialPriceList for post info
                const postInfo = currentMaterialPriceList[postTypeName];
                let currentPostMaterialCost = 0;

                if (postInfo) {
                    // Calculate how many posts can be cut from one stock length
                    const postsPerStockLength = Math.floor(postInfo.unitLength / quoteSections.posts.length);

                    if (postsPerStockLength <= 0) {
                        errors.push(`Post length (${quoteSections.posts.length}mm) is too long to be cut from a single stock length (${postInfo.unitLength}mm). Adjust fence height or post length settings.`);
                        showMessageBox("Input Error", errors.map(err => `• ${err}`).join('<br/>')); // Use message box for errors
                        return; // Stop calculation if posts cannot be cut
                    }

                    // Calculate the number of stock lengths needed
                    const postUnitsNeeded = Math.ceil(quoteSections.posts.numCalculated / postsPerStockLength);

                    const rawCostOfPosts = postUnitsNeeded * postInfo.pricePerUnit;
                    const costOfPostsWithProfit = rawCostOfPosts * (1 + currentProfitMargins.PROFIT_POSTS_MATERIAL); // Use new POSTS margin

                    quoteSections.posts.materialsBreakdown.push({
                        name: postTypeName,
                        displayAmount: postUnitsNeeded,
                        unitType: `x ${postInfo.unitLength}mm lengths (yields ${postsPerStockLength} posts per length for total ${quoteSections.posts.numCalculated} posts @ ${quoteSections.posts.length.toFixed(0)}mm each)`,
                        cost: costOfPostsWithProfit,
                        rawCost: rawCostOfPosts // Store raw cost
                    });
                    currentPostMaterialCost += costOfPostsWithProfit;

                    // Add material cost for caps
                    const capType = postSize === 65 ? '65x65 Caps' : '90x90 Caps';
                    // Use currentMaterialPriceList for cap info
                    const capInfo = currentMaterialPriceList[capType];
                    if (capInfo) {
                        const rawCapsMaterialCost = quoteSections.posts.numCalculated * capInfo.pricePerUnit;
                        const capsMaterialCostWithProfit = rawCapsMaterialCost * (1 + currentProfitMargins.PROFIT_CAPS_BRACKETS_MATERIAL); // Use new CAPS_BRACKETS margin
                        quoteSections.posts.materialsBreakdown.push({
                            name: capType,
                            displayAmount: quoteSections.posts.numCalculated,
                            unitType: 'pcs',
                            cost: capsMaterialCostWithProfit,
                            rawCost: rawCapsMaterialCost // Store raw cost
                        });
                        currentPostMaterialCost += capsMaterialCostWithProfit;
                    } else {
                        errors.push(`Price information for ${capType} not found.`);
                    }

                    quoteSections.posts.materialCost = currentPostMaterialCost;
                    quoteSections.totalMaterialCostWithProfit += currentPostMaterialCost;

                    // Powder coating for posts
                    const totalPostLengthMeters = (quoteSections.posts.numCalculated * quoteSections.posts.length) / 1000;
                    const powderCoatingRateForPost = powderCoatingRates[postTypeName];
                    const rawPowderCoatingCostForPosts = totalPostLengthMeters * powderCoatingRateForPost;
                    powderCoatingCostForPostsWithProfit = rawPowderCoatingCostForPosts * (1 + currentProfitMargins.PROFIT_POWDER_COATING); // Assign to outer variable

                    quoteSections.powderCoating.breakdown.push({
                        name: `${postTypeName} Powder Coat`,
                        displayAmount: totalPostLengthMeters.toFixed(2),
                        unitType: `meters`,
                        cost: powderCoatingCostForPostsWithProfit,
                        rawCost: rawPowderCoatingCostForPosts // Store raw cost
                    });
                    quoteSections.powderCoating.baseCost += powderCoatingCostForPostsWithProfit;

                    // Installation for posts
                    if (overallBoundaryLength > 0) {
                        quoteSections.totalInstallationCost += currentInstallationCosts.INSTALL_POSTS_FIXED;
                    }

                    // Calculate total for professional quote
                    totalPostsCost = quoteSections.posts.materialCost + powderCoatingCostForPostsWithProfit + currentInstallationCosts.INSTALL_POSTS_FIXED;

                } else {
                    errors.push(`Price information for ${postTypeName} not found.`);
                }
            }


            // --- Sliding Gate Material Calculation ---
            let powderCoatingCostForSlidingGateWithProfit = 0;
            let powderCoatingCostForGuideBracketWithProfit = 0;
            let powderCoatingCostFor50mmCatchWithProfit = 0;
            let totalSlidingGateCost = 0; // For professional quote summary

            if (quoteSections.slidingGate.present) {
                const sGateLength = quoteSections.slidingGate.length;
                const sGateHeight = fenceHeight;
                let currentSlidingGateMaterialCost = 0;

                let slidingGateRawMaterials = {
                    '100x50 RHS': 0, '40x40 SHS': 0, '50x10 Pickets': 0, 'Picket Top': 0, '40x40 Angle': 0
                };

                const rhsFramePart = sGateLength + 400 + postSize;
                const shsVerticalFramePart = (sGateHeight - 170) * 2;
                const shsHorizontalFramePart = sGateLength;

                slidingGateRawMaterials['100x50 RHS'] += rhsFramePart;
                slidingGateRawMaterials['40x40 SHS'] += shsVerticalFramePart + shsHorizontalFramePart;
                quoteSections.slidingGate.totalFrameLength = (rhsFramePart + shsVerticalFramePart + shsHorizontalFramePart) / 1000;

                const numPicketsSliding = Math.ceil(sGateLength / 90);
                const picketHeightSliding = sGateHeight;
                const totalPicketLengthSliding = numPicketsSliding * picketHeightSliding;
                slidingGateRawMaterials['50x10 Pickets'] += totalPicketLengthSliding;

                slidingGateRawMaterials['Picket Top'] += numPicketsSliding;

                slidingGateRawMaterials['40x40 Angle'] += sGateLength;

                for (const materialName in slidingGateRawMaterials) {
                    const requiredAmount = slidingGateRawMaterials[materialName];
                    // Use currentMaterialPriceList for material info
                    const materialInfo = currentMaterialPriceList[materialName];
                    if (requiredAmount > 0 && materialInfo) {
                        let rawCostForMaterial = 0; let displayAmount = 0; let unitType = '';
                        if (materialName === 'Picket Top') {
                            rawCostForMaterial = requiredAmount * materialInfo.pricePerUnit; displayAmount = requiredAmount; unitType = 'pcs';
                        } else if (materialName === '50x10 Pickets') {
                            const unitsNeededForPickets = calculateUnitsNeeded(requiredAmount, materialInfo.unitLength);
                            rawCostForMaterial = unitsNeededForPickets * materialInfo.pricePerUnit;
                            displayAmount = numPicketsSliding;
                            unitType = `pcs (each ${picketHeightSliding.toFixed(0)}mm / Total ${totalPicketLengthSliding.toFixed(0)}mm / ${unitsNeededForPickets} x ${materialInfo.unitLength}mm lengths)`;
                        }
                        else {
                            const unitsNeeded = calculateUnitsNeeded(requiredAmount, materialInfo.unitLength);
                            rawCostForMaterial = unitsNeeded * materialInfo.pricePerUnit; displayAmount = unitsNeeded; unitType = `x ${materialInfo.unitLength}mm lengths (Total ${requiredAmount.toFixed(0)}mm)`;
                        }
                        const costForMaterialWithProfit = rawCostForMaterial * (1 + currentProfitMargins.PROFIT_SLIDING_GATE_MATERIAL);
                        quoteSections.slidingGate.materialsBreakdown.push({ name: materialName, displayAmount: displayAmount, unitType: unitType, cost: costForMaterialWithProfit, rawCost: rawCostForMaterial }); // Store raw cost
                        currentSlidingGateMaterialCost += costForMaterialWithProfit;
                    }
                }
                quoteSections.slidingGate.materialCost = currentSlidingGateMaterialCost;
                quoteSections.totalMaterialCostWithProfit += currentSlidingGateMaterialCost;

                // Powder coating for sliding gate
                const gateSurfaceAreaM2 = (sGateLength / 1000) * (sGateHeight / 1000);
                const rawPowderCoatingCostForSlidingGate = gateSurfaceAreaM2 * powderCoatingRates['Panel_Gate_Area'];
                powderCoatingCostForSlidingGateWithProfit = rawPowderCoatingCostForSlidingGate * (1 + currentProfitMargins.PROFIT_POWDER_COATING);

                quoteSections.powderCoating.breakdown.push({
                    name: `Sliding Gate Frame Powder Coat`,
                    displayAmount: gateSurfaceAreaM2.toFixed(2),
                    unitType: `sq meters`,
                    cost: powderCoatingCostForSlidingGateWithProfit,
                    rawCost: rawPowderCoatingCostForSlidingGate // Store raw cost
                });
                quoteSections.powderCoating.baseCost += powderCoatingCostForSlidingGateWithProfit;

                // Installation for sliding gate
                quoteSections.totalInstallationCost += currentInstallationCosts.INSTALL_SLIDING_GATE_FIXED;


                // Sliding Gate Fittings Calculation
                if (quoteSections.slidingGateFittings.present) {
                    let currentSlidingGateFittingsMaterialCost = 0;

                    const fittingItems = [
                        { name: 'Guide Rollers', qty: 2, key: 'Guide Rollers', profitMargin: currentProfitMargins.PROFIT_GATE_MOTOR_HARDWARE, powderCoat: false },
                        { name: 'Guide Bracket', qty: 1, key: 'Guide Bracket', profitMargin: currentProfitMargins.PROFIT_GATE_MOTOR_HARDWARE, powderCoat: true, powderCoatVar: 'powderCoatingCostForGuideBracketWithProfit' },
                        { name: '100x50 Cap', qty: 2, key: '100x50 Cap', profitMargin: currentProfitMargins.PROFIT_GATE_MOTOR_HARDWARE, powderCoat: false },
                        { name: 'Gate Wheel', qty: 2, key: 'Gate Wheel', profitMargin: currentProfitMargins.PROFIT_GATE_MOTOR_HARDWARE, powderCoat: false },
                        { name: '50mm Catch', qty: 1, key: '50mm Catch', profitMargin: currentProfitMargins.PROFIT_GATE_MOTOR_HARDWARE, powderCoat: true, powderCoatVar: 'powderCoatingCostFor50mmCatchWithProfit' },
                    ];

                    fittingItems.forEach(item => {
                        // Use currentMaterialPriceList for material info
                        const materialInfo = currentMaterialPriceList[item.key];
                        if (materialInfo) {
                            const rawCost = item.qty * materialInfo.pricePerUnit;
                            const costWithProfit = rawCost * (1 + item.profitMargin);
                            quoteSections.slidingGateFittings.materialsBreakdown.push({
                                name: item.name,
                                displayAmount: item.qty,
                                unitType: 'pcs',
                                cost: costWithProfit,
                                rawCost: rawCost // Store raw cost
                            });
                            currentSlidingGateFittingsMaterialCost += costWithProfit;

                            // Add powder coating cost if applicable
                            if (item.powderCoat) {
                                const rawPowderCoatCost = item.qty * powderCoatingRates['Per_Piece_Powder_Coat'];
                                const powderCoatCostWithProfit = rawPowderCoatCost * (1 + currentProfitMargins.PROFIT_POWDER_COATING);
                                quoteSections.powderCoating.breakdown.push({
                                    name: `${item.name} Powder Coat`,
                                    displayAmount: item.qty,
                                    unitType: 'pcs',
                                    cost: powderCoatCostWithProfit,
                                    rawCost: rawPowderCoatCost // Store raw cost
                                });
                                quoteSections.powderCoating.baseCost += powderCoatCostWithProfit;

                                if (item.powderCoatVar === 'powderCoatingCostForGuideBracketWithProfit') {
                                    powderCoatingCostForGuideBracketWithProfit = powderCoatCostWithProfit;
                                } else if (item.powderCoatVar === 'powderCoatingCostFor50mmCatchWithProfit') {
                                    powderCoatingCostFor50mmCatchWithProfit = powderCoatCostWithProfit;
                                }
                            }

                        } else {
                            errors.push(`Price information for ${item.name} not found.`);
                        }
                    });

                    // Gate Track calculation (dynamic based on gate length)
                    // Use currentMaterialPriceList for gate track info
                    const gateTrackInfo = currentMaterialPriceList['Gate Track'];
                    if (gateTrackInfo) {
                        const requiredTrackLengthMM = Math.max(0, (sGateLength - 2000)) * 2;
                        const trackUnitsNeeded = calculateUnitsNeeded(requiredTrackLengthMM, gateTrackInfo.unitLength);
                        const rawCostOfTrack = trackUnitsNeeded * gateTrackInfo.pricePerUnit;
                        const costOfTrackWithProfit = rawCostOfTrack * (1 + currentProfitMargins.PROFIT_GATE_MOTOR_HARDWARE);
                        quoteSections.slidingGateFittings.materialsBreakdown.push({
                            name: 'Gate Track',
                            displayAmount: trackUnitsNeeded,
                            unitType: `x ${gateTrackInfo.unitLength/1000}m lengths (Total ${requiredTrackLengthMM.toFixed(0)}mm)`,
                            cost: costOfTrackWithProfit,
                            rawCost: rawCostOfTrack // Store raw cost
                        });
                        currentSlidingGateFittingsMaterialCost += costOfTrackWithProfit;
                    } else {
                        errors.push('Price information for Gate Track not found.');
                    }

                    quoteSections.slidingGateFittings.materialCost = currentSlidingGateFittingsMaterialCost;
                    quoteSections.totalMaterialCostWithProfit += currentSlidingGateFittingsMaterialCost;
                }
                totalSlidingGateCost = quoteSections.slidingGate.materialCost + quoteSections.slidingGateFittings.materialCost + powderCoatingCostForSlidingGateWithProfit + powderCoatingCostForGuideBracketWithProfit + powderCoatingCostFor50mmCatchWithProfit + currentInstallationCosts.INSTALL_SLIDING_GATE_FIXED;
            }


            // --- Pedestrian Gate Material Calculation ---
            let powderCoatingCostForPedestrianGateFrameWithProfit = 0;
            let hingesPowderCostWithProfit = 0;
            let latchPowderCostWithProfit = 0;
            let totalPedestrianGateCost = 0; // For professional quote summary

            if (pedestrianGateYes.checked) {
                const pGateWidth = quoteSections.pedestrianGate.width;
                const pGateHeight = fenceHeight;
                const chosenHingeType = quoteSections.pedestrianGate.hingeType;
                const chosenLatchType = quoteSections.pedestrianGate.latchType;
                let currentPedestrianGateMaterialCost = 0;

                // First, add costs for hinges and latches (material cost)
                // Use currentMaterialPriceList for hinge and latch info
                const hingeInfo = currentMaterialPriceList[chosenHingeType];
                const latchInfo = currentMaterialPriceList[chosenLatchType];

                if (hingeInfo) {
                    const rawHingesCost = hingeInfo.pricePerUnit * 2;
                    const hingesCostWithProfit = rawHingesCost * (1 + currentProfitMargins.PROFIT_PEDESTRIAN_GATE_MATERIAL);
                    quoteSections.pedestrianGate.materialsBreakdown.push({
                        name: chosenHingeType,
                        displayAmount: 2,
                        unitType: 'pcs',
                        cost: hingesCostWithProfit,
                        rawCost: rawHingesCost // Store raw cost
                    });
                    currentPedestrianGateMaterialCost += hingesCostWithProfit;
                } else {
                    errors.push(`Price information for ${chosenHingeType} not found.`);
                }

                if (latchInfo) {
                    const rawLatchCost = latchInfo.pricePerUnit * 1;
                    const latchCostWithProfit = rawLatchCost * (1 + currentProfitMargins.PROFIT_PEDESTRIAN_GATE_MATERIAL);
                    quoteSections.pedestrianGate.materialsBreakdown.push({
                        name: chosenLatchType,
                        displayAmount: 1,
                        unitType: 'pcs',
                        cost: latchCostWithProfit,
                        rawCost: rawLatchCost // Store raw cost
                    });
                    currentPedestrianGateMaterialCost += latchCostWithProfit;
                } else {
                    errors.push(`Price information for ${chosenLatchType} not found.`);
                }

                // Now, calculate the raw materials for the gate frame and pickets
                let pedestrianGateRawMaterials = {
                    '40x40 SHS': 0, '50x10 Pickets': 0, 'Picket Top': 0
                };

                const shsVerticalFramePart = (pGateHeight - 170) * 2;
                const shsHorizontalFramePart = (pGateWidth - 130) * 2;

                pedestrianGateRawMaterials['40x40 SHS'] += shsVerticalFramePart + shsHorizontalFramePart;
                quoteSections.pedestrianGate.totalFrameLength = (shsVerticalFramePart + shsHorizontalFramePart) / 1000;

                const numPicketsPedestrian = Math.ceil(pGateWidth / 90);
                const picketHeightPedestrian = pGateHeight;
                const totalPicketLengthPedestrian = numPicketsPedestrian * picketHeightPedestrian;
                pedestrianGateRawMaterials['50x10 Pickets'] += totalPicketLengthPedestrian;
                pedestrianGateRawMaterials['Picket Top'] += numPicketsPedestrian;


                for (const materialName in pedestrianGateRawMaterials) {
                    const requiredAmount = pedestrianGateRawMaterials[materialName];
                    // Use currentMaterialPriceList for material info
                    const materialInfo = currentMaterialPriceList[materialName];
                    if (requiredAmount > 0 && materialInfo) {
                        let rawCostForMaterial = 0; let displayAmount = 0; let unitType = '';
                        if (materialName === 'Picket Top') {
                            rawCostForMaterial = requiredAmount * materialInfo.pricePerUnit; displayAmount = requiredAmount; unitType = 'pcs';
                        } else if (materialName === '50x10 Pickets') {
                            const unitsNeededForPickets = calculateUnitsNeeded(requiredAmount, materialInfo.unitLength);
                            rawCostForMaterial = unitsNeededForPickets * materialInfo.pricePerUnit;
                            displayAmount = numPicketsPedestrian;
                            unitType = `pcs (each ${picketHeightPedestrian.toFixed(0)}mm / Total ${totalPicketLengthPedestrian.toFixed(0)}mm / ${unitsNeededForPickets} x ${materialInfo.unitLength}mm lengths)`;
                        }
                        else {
                            const unitsNeeded = calculateUnitsNeeded(requiredAmount, materialInfo.unitLength);
                            rawCostForMaterial = unitsNeeded * materialInfo.pricePerUnit; displayAmount = unitsNeeded; unitType = `x ${materialInfo.unitLength}mm lengths (Total ${requiredAmount.toFixed(0)}mm)`;
                        }
                        const costForMaterialWithProfit = rawCostForMaterial * (1 + currentProfitMargins.PROFIT_PEDESTRIAN_GATE_MATERIAL);
                        quoteSections.pedestrianGate.materialsBreakdown.push({ name: materialName, displayAmount: displayAmount, unitType: unitType, cost: costForMaterialWithProfit, rawCost: rawCostForMaterial }); // Store raw cost
                        currentPedestrianGateMaterialCost += costForMaterialWithProfit;
                    }
                }
                quoteSections.pedestrianGate.materialCost = currentPedestrianGateMaterialCost;
                quoteSections.totalMaterialCostWithProfit += currentPedestrianGateMaterialCost;

                // Powder coating for pedestrian gate (frame)
                const gateSurfaceAreaM2 = (pGateWidth / 1000) * (pGateHeight / 1000);
                const rawPowderCoatingCostForPedestrianGateFrame = gateSurfaceAreaM2 * powderCoatingRates['Panel_Gate_Area'];
                powderCoatingCostForPedestrianGateFrameWithProfit = rawPowderCoatingCostForPedestrianGateFrame * (1 + currentProfitMargins.PROFIT_POWDER_COATING);

                quoteSections.powderCoating.breakdown.push({
                    name: `Pedestrian Gate Frame Powder Coat`,
                    displayAmount: gateSurfaceAreaM2.toFixed(2),
                    unitType: `sq meters`,
                    cost: powderCoatingCostForPedestrianGateFrameWithProfit,
                    rawCost: rawPowderCoatingCostForPedestrianGateFrame // Store raw cost
                });
                quoteSections.powderCoating.baseCost += powderCoatingCostForPedestrianGateFrameWithProfit;

                // Powder coating for hinges and latch if applicable
                if (chosenHingeType === 'Adjustable Hinges') {
                    const rawHingesPowderCost = 2 * powderCoatingRates['Per_Piece_Powder_Coat'];
                    hingesPowderCostWithProfit = rawHingesPowderCost * (1 + currentProfitMargins.PROFIT_POWDER_COATING);
                    quoteSections.powderCoating.breakdown.push({
                        name: `${chosenHingeType} Powder Coat`,
                        displayAmount: 2,
                        unitType: 'pcs',
                        cost: hingesPowderCostWithProfit,
                        rawCost: rawHingesPowderCost // Store raw cost
                    });
                    quoteSections.powderCoating.baseCost += hingesPowderCostWithProfit;
                }
                if (chosenLatchType === 'D latch') {
                    const rawLatchPowderCost = 1 * powderCoatingRates['Per_Piece_Powder_Coat'];
                    latchPowderCostWithProfit = rawLatchPowderCost * (1 + currentProfitMargins.PROFIT_POWDER_COATING);
                    quoteSections.powderCoating.breakdown.push({
                        name: `${chosenLatchType} Powder Coat`,
                        displayAmount: 1,
                        unitType: 'pcs',
                        cost: latchPowderCostWithProfit,
                        rawCost: rawLatchPowderCost // Store raw cost
                    });
                    quoteSections.powderCoating.baseCost += latchPowderCostWithProfit;
                }

                // Installation for pedestrian gate
                quoteSections.totalInstallationCost += currentInstallationCosts.INSTALL_PEDESTRIAN_GATE_FIXED;

                totalPedestrianGateCost = quoteSections.pedestrianGate.materialCost + powderCoatingCostForPedestrianGateFrameWithProfit + hingesPowderCostWithProfit + latchPowderCostWithProfit + currentInstallationCosts.INSTALL_PEDESTRIAN_GATE_FIXED;
            }

            // --- Fence Panels Calculation ---
            let powderCoatingCostForFencePanelsWithProfit = 0;
            let bracketsPowderCostWithProfit = 0;
            let panelInstallCost = 0;
            let totalFencePanelsCost = 0; // For professional quote summary

            if (quoteSections.fencePanels.present && quoteSections.fencePanels.individualPanelLengths.length > 0) {
                const fenceHeight = parseFloat(fenceHeightInput.value) || 0;
                let currentFencePanelsMaterialCost = 0;

                let panelRawMaterialsAggregated = {
                    '40x40 SHS': 0, // Frame
                    '50x10 Pickets': 0,
                    'Picket Top': 0,
                    '40x40 Rail Brackets': 0 // Material for brackets
                };

                quoteSections.fencePanels.individualPanelLengths.forEach(panelLength => {
                    // 40x40 SHS: 2 lengths at the panel length for top/bottom rails
                    panelRawMaterialsAggregated['40x40 SHS'] += (2 * panelLength);

                    // 50x10 Pickets & Picket Tops
                    const numPicketsPerPanel = Math.ceil(panelLength / 90);
                    const picketHeight = fenceHeight;
                    panelRawMaterialsAggregated['50x10 Pickets'] += (numPicketsPerPanel * picketHeight);
                    panelRawMaterialsAggregated['Picket Top'] += numPicketsPerPanel;

                    // Rail Brackets: 4 per panel (2 rails x 2 ends)
                    panelRawMaterialsAggregated['40x40 Rail Brackets'] += 4;
                });

                for (const materialName in panelRawMaterialsAggregated) {
                    const requiredAmount = panelRawMaterialsAggregated[materialName];
                    // Use currentMaterialPriceList for material info
                    const materialInfo = currentMaterialPriceList[materialName];

                    if (requiredAmount > 0 && materialInfo) {
                        let rawCostForMaterial = 0;
                        let displayAmount = 0;
                        let unitType = '';
                        let profitMarginToApply = currentProfitMargins.PROFIT_PANELS_MATERIAL; // Default for panels

                        if (materialName === 'Picket Top') {
                            rawCostForMaterial = requiredAmount * materialInfo.pricePerUnit;
                            displayAmount = requiredAmount;
                            unitType = 'pcs';
                        } else if (materialName === '50x10 Pickets') {
                            const numTotalPickets = requiredAmount / fenceHeight;
                            const unitsNeededForPickets = calculateUnitsNeeded(requiredAmount, materialInfo.unitLength);
                            rawCostForMaterial = unitsNeededForPickets * materialInfo.pricePerUnit;
                            displayAmount = numTotalPickets.toFixed(0);
                            unitType = `pcs (each ${fenceHeight.toFixed(0)}mm / Total ${requiredAmount.toFixed(0)}mm / ${unitsNeededForPickets} x ${materialInfo.unitLength}mm lengths)`;
                        } else if (materialName === '40x40 Rail Brackets') {
                             rawCostForMaterial = requiredAmount * materialInfo.pricePerUnit;
                             displayAmount = requiredAmount;
                             unitType = 'pcs';
                             profitMarginToApply = currentProfitMargins.PROFIT_CAPS_BRACKETS_MATERIAL; // Use new CAPS_BRACKETS margin for brackets
                        }
                        else { // For 40x40 SHS
                            const unitsNeeded = calculateUnitsNeeded(requiredAmount, materialInfo.unitLength);
                            rawCostForMaterial = unitsNeeded * materialInfo.pricePerUnit;
                            displayAmount = unitsNeeded;
                            unitType = `x ${materialInfo.unitLength}mm lengths (Total ${requiredAmount.toFixed(0)}mm)`;
                        }
                        const costForMaterialWithProfit = rawCostForMaterial * (1 + profitMarginToApply);
                        quoteSections.fencePanels.materialsBreakdown.push({ name: materialName, displayAmount: displayAmount, unitType: unitType, cost: costForMaterialWithProfit, rawCost: rawCostForMaterial }); // Store raw cost
                        currentFencePanelsMaterialCost += costForMaterialWithProfit;
                    }
                }
                quoteSections.fencePanels.materialCost = currentFencePanelsMaterialCost;
                quoteSections.totalMaterialCostWithProfit += currentFencePanelsMaterialCost;


                // Powder coating for fence panels
                const totalPanelSurfaceAreaM2 = (quoteSections.fencePanels.totalLength / 1000) * (fenceHeight / 1000);
                const rawPowderCoatingCostForFencePanels = totalPanelSurfaceAreaM2 * powderCoatingRates['Panel_Gate_Area'];
                powderCoatingCostForFencePanelsWithProfit = rawPowderCoatingCostForFencePanels * (1 + currentProfitMargins.PROFIT_POWDER_COATING);

                quoteSections.powderCoating.breakdown.push({
                    name: `Fence Panels Powder Coat`,
                    displayAmount: totalPanelSurfaceAreaM2.toFixed(2),
                    unitType: `sq meters`,
                    cost: powderCoatingCostForFencePanelsWithProfit,
                    rawCost: rawPowderCoatingCostForFencePanels // Store raw cost
                });
                quoteSections.powderCoating.baseCost += powderCoatingCostForFencePanelsWithProfit;

                // Installation for fence panels
                const totalPanelsLengthMeters = quoteSections.fencePanels.totalLength / 1000;
                panelInstallCost = (totalPanelsLengthMeters * currentInstallationCosts.INSTALL_PANELS_PER_METER);

                // Add miscellaneous powder coating (rail brackets)
                const numRailBrackets = quoteSections.fencePanels.numPanels * 4;
                if (numRailBrackets > 0) {
                    const rawBracketsPowderCost = numRailBrackets * powderCoatingRates['Per_Piece_Powder_Coat'];
                    bracketsPowderCostWithProfit = rawBracketsPowderCost * (1 + currentProfitMargins.PROFIT_POWDER_COATING);
                    quoteSections.powderCoating.breakdown.push({
                        name: '40x40 Rail Brackets Powder Coat',
                        displayAmount: numRailBrackets,
                        unitType: 'pcs',
                        cost: bracketsPowderCostWithProfit,
                        rawCost: rawBracketsPowderCost // Store raw cost
                    });
                    quoteSections.powderCoating.baseCost += bracketsPowderCostWithProfit;
                }
                totalFencePanelsCost = quoteSections.fencePanels.materialCost + powderCoatingCostForFencePanelsWithProfit + bracketsPowderCostWithProfit + panelInstallCost;
            }

            // --- Fabrication Costs Calculation ---
            let totalFabricationCostForSummary = 0; // Initialize for professional quote summary
            if (overallBoundaryLength > 0 || quoteSections.slidingGate.present || quoteSections.pedestrianGate.present) {
                const rawFabricationCost = currentFabricationCosts.FABRICATION_COST_PER_DAY * currentFabricationCosts.FABRICATION_DAYS_PER_JOB;
                // Assuming fabrication has no direct profit margin or it's included in the daily rate
                quoteSections.totalFabricationCost = rawFabricationCost;
                totalFabricationCostForSummary = rawFabricationCost; // Capture for summary
                quoteSections.fabrication.breakdown.push({
                    name: "Fabrication (Total)",
                    displayAmount: currentFabricationCosts.FABRICATION_DAYS_PER_JOB,
                    unitType: `days @ $${currentFabricationCosts.FABRICATION_COST_PER_DAY.toFixed(2)}/day`,
                    cost: rawFabricationCost, // Here cost and rawCost are the same as no profit applied
                    rawCost: rawFabricationCost
                });
            }

            // --- Final Calculations and Display ---
            // Sum up all calculated costs for the total quote
            const finalOverallCost = totalPostsCost + totalSlidingGateCost + (quoteSections.gateMotors.present ? (quoteSections.gateMotors.motorMaterialCost + quoteSections.gateMotors.hardwareMaterialCost + motorInstallCostForSummary) : 0) + totalPedestrianGateCost + totalFencePanelsCost + totalFabricationCostForSummary;


            let hasContentToDisplay = false; // Check if any section has content to display in general results

            // Posts Section Display
            if (quoteSections.posts.materialCost > 0 || quoteSections.posts.numCalculated > 0) {
                postsSection.classList.remove('hidden');
                calculatedNumPostsDisplay.textContent = quoteSections.posts.numCalculated;
                calculatedPostLengthDisplay.textContent = `${quoteSections.posts.length.toFixed(0)}mm`;
                postsMaterialsDiv.innerHTML = '';
                quoteSections.posts.materialsBreakdown.forEach(mat => {
                    postsMaterialsDiv.innerHTML += formatLineItem(mat.name, mat.displayAmount, mat.unitType, mat.rawCost, mat.cost);
                });
                postsSubtotalSpan.textContent = `$${quoteSections.posts.materialCost.toFixed(2)}`;
                postsSectionTitle.textContent = `Posts ($${quoteSections.posts.materialCost.toFixed(2)})`; // Update button text with subtotal
                hasContentToDisplay = true;
            }

            // Sliding Gate Section Display
            if (quoteSections.slidingGate.present) {
                slidingGateSection.classList.remove('hidden');
                slidingGateMaterialsDiv.innerHTML = '';
                quoteSections.slidingGate.materialsBreakdown.forEach(mat => {
                    slidingGateMaterialsDiv.innerHTML += formatLineItem(mat.name, mat.displayAmount, mat.unitType, mat.rawCost, mat.cost);
                });
                slidingGateSubtotalSpan.textContent = `$${quoteSections.slidingGate.materialCost.toFixed(2)}`;
                slidingGateSectionTitle.textContent = `Sliding Gate ($${quoteSections.slidingGate.materialCost.toFixed(2)})`; // Update button text with subtotal
                hasContentToDisplay = true;
            }

            // Sliding Gate Fittings Section Display
            if (quoteSections.slidingGateFittings.present) {
                slidingGateFittingsSection.classList.remove('hidden');
                slidingGateFittingsMaterialsDiv.innerHTML = '';
                quoteSections.slidingGateFittings.materialsBreakdown.forEach(mat => {
                    slidingGateFittingsMaterialsDiv.innerHTML += formatLineItem(mat.name, mat.displayAmount, mat.unitType, mat.rawCost, mat.cost);
                });
                slidingGateFittingsSubtotalSpan.textContent = `$${quoteSections.slidingGateFittings.materialCost.toFixed(2)}`;
                slidingGateFittingsSectionTitle.textContent = `Sliding Gate Fittings ($${quoteSections.slidingGateFittings.materialCost.toFixed(2)})`; // Update button text with subtotal
                hasContentToDisplay = true;
            }

            // Gate Motors & Accessories Section Display
            if (quoteSections.gateMotors.present) {
                gateMotorsSection.classList.remove('hidden');
                gateMotorsMaterialsDiv.innerHTML = '';
                // Display motor first
                quoteSections.gateMotors.motorBreakdown.forEach(mat => {
                    gateMotorsMaterialsDiv.innerHTML += formatLineItem(mat.name, mat.displayAmount, mat.unitType, mat.rawCost, mat.cost);
                });
                // Then hardware
                if (quoteSections.gateMotors.hardwareBreakdown.length > 0) {
                     if (quoteSections.gateMotors.motorBreakdown.length > 0) {
                         // Add a separator or sub-heading for add-ons if needed, but not part of formatLineItem
                         gateMotorsMaterialsDiv.innerHTML += `<div class="font-semibold text-gray-700 mt-2">Motor Add-ons:</div>`;
                     }
                    quoteSections.gateMotors.hardwareBreakdown.forEach(mat => {
                        gateMotorsMaterialsDiv.innerHTML += formatLineItem(mat.name, mat.displayAmount, mat.unitType, mat.rawCost, mat.cost);
                    });
                }
                const gateMotorsTotal = quoteSections.gateMotors.motorMaterialCost + quoteSections.gateMotors.hardwareMaterialCost;
                gateMotorsSubtotalSpan.textContent = `$${gateMotorsTotal.toFixed(2)}`;
                gateMotorsSectionTitle.textContent = `Gate Motors & Accessories ($${gateMotorsTotal.toFixed(2)})`; // Update button text with subtotal
                hasContentToDisplay = true;
            }

            // Pedestrian Gate Section Display
            if (quoteSections.pedestrianGate.present) {
                pedestrianGateSection.classList.remove('hidden');
                pedestrianGateMaterialsDiv.innerHTML = '';
                quoteSections.pedestrianGate.materialsBreakdown.forEach(mat => {
                    pedestrianGateMaterialsDiv.innerHTML += formatLineItem(mat.name, mat.displayAmount, mat.unitType, mat.rawCost, mat.cost);
                });
                pedestrianGateSubtotalSpan.textContent = `$${quoteSections.pedestrianGate.materialCost.toFixed(2)}`;
                pedestrianGateSectionTitle.textContent = `Pedestrian Gate ($${quoteSections.pedestrianGate.materialCost.toFixed(2)})`; // Update button text with subtotal
                hasContentToDisplay = true;
            }

            // Fence Panels Section Display
            if (quoteSections.fencePanels.present) {
                fencePanelsSection.classList.remove('hidden');
                const panelDisplayStringForResults = getPanelDisplayString(quoteSections.fencePanels.individualPanelLengths, IDEAL_PANEL_2_4M);

                // Update the new display elements
                displayNumPanelsActual.textContent = quoteSections.fencePanels.numPanels;
                displayPanelLengthActual.textContent = panelDisplayStringForResults;
                displayFenceLinearLengthActual.textContent = `${quoteSections.fencePanels.totalLength.toFixed(0)}mm`;

                fencePanelsMaterialsDiv.innerHTML = ''; // Clear only the material list for panels
                quoteSections.fencePanels.materialsBreakdown.forEach(mat => {
                    fencePanelsMaterialsDiv.innerHTML += formatLineItem(mat.name, mat.displayAmount, mat.unitType, mat.rawCost, mat.cost);
                });
                fencePanelsSubtotalSpan.textContent = `$${quoteSections.fencePanels.materialCost.toFixed(2)}`;
                fencePanelsSectionTitle.textContent = `Fence Panels ($${quoteSections.fencePanels.materialCost.toFixed(2)})`; // Update button text with subtotal
                hasContentToDisplay = true;
            } else {
                fencePanelsSection.classList.add('hidden');
            }

            // Powder Coating Section Display
            if (quoteSections.powderCoating.baseCost > 0) {
                powderCoatingSection.classList.remove('hidden');
                powderCoatingDetailsDiv.innerHTML = '';
                quoteSections.powderCoating.breakdown.forEach(item => {
                    powderCoatingDetailsDiv.innerHTML += formatLineItem(item.name, item.displayAmount, item.unitType, item.rawCost, item.cost);
                });
                powderCoatingTotalSpan.textContent = `$${quoteSections.powderCoating.baseCost.toFixed(2)}`;
                powderCoatingSectionTitle.textContent = `Powder Coating ($${quoteSections.powderCoating.baseCost.toFixed(2)})`; // Update button text with subtotal
                hasContentToDisplay = true;
            }

            // Fabrication Costs Section Display
            // Note: For Fabrication and Installation, we assume the input cost is already the "final" cost with no further profit layer
            if (quoteSections.totalFabricationCost > 0) {
                fabricationCostsSection.classList.remove('hidden');
                // The rawCost for fabrication is the total fabrication cost itself in this context
                quoteSections.fabrication.breakdown.forEach(item => { // Iterate over the breakdown
                    fabricationDetailsDiv.innerHTML += formatLineItem(item.name, item.displayAmount, item.unitType, item.rawCost, item.cost);
                });
                fabricationTotalSpan.textContent = `$${quoteSections.totalFabricationCost.toFixed(2)}`;
                fabricationCostsSectionTitle.textContent = `Fabrication ($${quoteSections.totalFabricationCost.toFixed(2)})`; // Update button text with subtotal
                hasContentToDisplay = true;
            }


            // Installation Costs Section Display
            if (quoteSections.totalInstallationCost > 0) {
                installationCostsSection.classList.remove('hidden');
                installationDetailsDiv.innerHTML = '';
                if (overallBoundaryLength > 0) {
                    installationDetailsDiv.innerHTML += formatLineItem("Post Installation (fixed)", 1, 'job', currentInstallationCosts.INSTALL_POSTS_FIXED, currentInstallationCosts.INSTALL_POSTS_FIXED);
                }
                if (quoteSections.slidingGate.present) {
                    installationDetailsDiv.innerHTML += formatLineItem("Sliding Gate Installation (fixed)", 1, 'job', currentInstallationCosts.INSTALL_SLIDING_GATE_FIXED, currentInstallationCosts.INSTALL_SLIDING_GATE_FIXED);
                }
                if (quoteSections.pedestrianGate.present) {
                    installationDetailsDiv.innerHTML += formatLineItem("Pedestrian Gate Installation (fixed)", 1, 'job', currentInstallationCosts.INSTALL_PEDESTRIAN_GATE_FIXED, currentInstallationCosts.INSTALL_PEDESTRIAN_GATE_FIXED);
                }
                if (quoteSections.fencePanels.present) {
                    const totalPanelsLengthMeters = quoteSections.fencePanels.totalLength / 1000;
                    const panelInstallCostDisplay = totalPanelsLengthMeters * currentInstallationCosts.INSTALL_PANELS_PER_METER;
                    installationDetailsDiv.innerHTML += formatLineItem("Panel Installation (per meter)", totalPanelsLengthMeters.toFixed(2), 'meters', panelInstallCostDisplay, panelInstallCostDisplay);
                }
                if (quoteSections.gateMotors.present) { // Add motor installation to details
                    installationDetailsDiv.innerHTML += formatLineItem("Motor Installation (fixed)", 1, 'job', currentInstallationCosts.INSTALL_MOTOR_FIXED, currentInstallationCosts.INSTALL_MOTOR_FIXED);
                }
                installationTotalSpan.textContent = `$${quoteSections.totalInstallationCost.toFixed(2)}`;
                installationCostsSectionTitle.textContent = `Installation ($${quoteSections.totalInstallationCost.toFixed(2)})`; // Update button text with subtotal
                hasContentToDisplay = true;
            }

            // Only show results section if there's any content to display or a total cost
            if (hasContentToDisplay || finalOverallCost > 0) {
                resultsDiv.classList.remove('hidden');

                // Prepare data for drawing
                const layoutData = {
                    overallLength: overallBoundaryLength,
                    slidingGate: {
                        present: quoteSections.slidingGate.present,
                        length: quoteSections.slidingGate.length
                    },
                    pedestrianGate: {
                        present: quoteSections.pedestrianGate.present,
                        width: quoteSections.pedestrianGate.width
                    },
                    panels: {
                        present: quoteSections.fencePanels.present,
                        numPanels: quoteSections.fencePanels.numPanels,
                        individualPanelLengths: quoteSections.fencePanels.individualPanelLengths
                    },
                };
                drawFenceLayout(layoutData);

                // --- Generate Professional Quote Summary ---
                let professionalQuoteHtml = '';

                // Set customer name in summary
                const customerName = customerNameInput.value.trim();
                if (customerName) {
                    customerNameDisplay.textContent = `Customer: ${customerName}`;
                } else {
                    customerNameDisplay.textContent = ''; // Clear if no name
                }


                // Posts Line Item
                if (totalPostsCost > 0) {
                    professionalQuoteHtml += formatProfessionalQuoteLineItem(
                        `Supply and install ${quoteSections.posts.numCalculated} ${postSize}x${postSize} posts @ ${quoteSections.posts.length.toFixed(0)}mm`,
                        totalPostsCost
                    );
                }

                // Sliding Gate Line Item
                if (totalSlidingGateCost > 0) {
                    professionalQuoteHtml += formatProfessionalQuoteLineItem(
                        `Supply and install blade ${fenceHeight.toFixed(0)}mm x ${quoteSections.slidingGate.length.toFixed(0)}mm sliding gate`,
                        totalSlidingGateCost
                    );
                }

                // Gate Motor Line Item
                if (quoteSections.gateMotors.present) {
                    let motorDescription = `Supply and install DEA ${motorTypeSelect.value}`;
                    const ziggyQty = parseInt(ziggyRemoteQtyInput.value);
                    if (ziggyRemoteCheckbox.checked && ziggyQty > 0) {
                        motorDescription += ` w/ ${ziggyQty} remote${ziggyQty > 1 ? 's' : ''}`;
                    } else {
                        motorDescription += ` w/ 2 remotes`; // Default phrasing
                    }
                    if (batteryBackupCheckbox.checked) {
                        motorDescription += `, Battery backup`;
                    }
                    if (antennaCheckbox.checked) {
                        motorDescription += `, and Antenna`;
                    }
                    // Sum of motor material, hardware, and installation for the summary line
                    const totalGateMotorsCostForSummary = quoteSections.gateMotors.motorMaterialCost + quoteSections.gateMotors.hardwareMaterialCost + motorInstallCostForSummary;
                    professionalQuoteHtml += formatProfessionalQuoteLineItem(
                        motorDescription,
                        totalGateMotorsCostForSummary
                    );
                }

                // Pedestrian Gate Line Item
                if (totalPedestrianGateCost > 0) {
                    professionalQuoteHtml += formatProfessionalQuoteLineItem(
                        `Supply and install ${fenceHeight.toFixed(0)}mm x ${quoteSections.pedestrianGate.width.toFixed(0)}mm PA gate`,
                        totalPedestrianGateCost
                    );
                }

                // Fence Panels Line Item
                if (totalFencePanelsCost > 0) {
                    const panelDisplayString = getPanelDisplayString(quoteSections.fencePanels.individualPanelLengths, IDEAL_PANEL_2_4M);
                    professionalQuoteHtml += formatProfessionalQuoteLineItem(
                        `Supply and install ${panelDisplayString} Blade fence panels`,
                        totalFencePanelsCost
                    );
                }

                // Fabrication Line Item
                if (totalFabricationCostForSummary > 0) {
                    professionalQuoteHtml += formatProfessionalQuoteLineItem(
                        `Fabrication costs for ${currentFabricationCosts.FABRICATION_DAYS_PER_JOB} days`,
                        totalFabricationCostForSummary
                    );
                }


                quoteSummaryItemsDiv.innerHTML = professionalQuoteHtml;
                finalProfessionalQuoteTotalSpan.textContent = `$${finalOverallCost.toFixed(2)}`;
                professionalQuoteSummaryDiv.classList.remove('hidden');
            } else {
                showMessageBox("No Items Selected", "Please enter details for at least one section (Overall Boundary or Gates) to generate a quote.");
            }

            totalCostSpan.textContent = `$${finalOverallCost.toFixed(2)}`;
        });

        /**
         * Saves the current advanced settings to localStorage.
         */
        function saveSettings() {
            const settings = {
                customerName: customerNameInput.value, // Save customer name
                profitSlidingGateMaterial: profitSlidingGateMaterialInput.value,
                profitPedestrianGateMaterial: profitPedestrianGateMaterialInput.value,
                profitPanelsMaterial: profitPanelsMaterialInput.value,
                profitPostsMaterial: profitPostsMaterialInput.value,
                profitCapsBracketsMaterial: profitCapsBracketsMaterialInput.value,
                profitPowderCoating: profitPowderCoatingInput.value,
                profitGateMotors: profitGateMotorsInput.value,
                profitGateMotorHardware: profitGateMotorHardwareInput.value,

                installPostsFixed: installPostsFixedInput.value,
                installSlidingGateFixed: installSlidingGateFixedInput.value,
                installPedestrianGateFixed: installPedestrianGateFixedInput.value,
                installPanelsPerMeter: installPanelsPerMeterInput.value,
                installMotorFixed: installMotorFixedInput.value, // Save new motor install cost

                fabricationCostPerDay: fabricationCostPerDayInput.value,
                fabricationDaysPerJob: fabricationDaysPerJobInput.value,

                materialCosts: {} // To store dynamic material costs
            };

            // Capture all dynamic material costs
            for (const key in defaultMaterialPriceList) {
                const inputId = `material-${key.replace(/\s+/g, '-')}-cost`;
                const inputElement = document.getElementById(inputId);
                if (inputElement) {
                    settings.materialCosts[key] = inputElement.value;
                }
            }

            try {
                localStorage.setItem(SETTINGS_STORAGE_KEY, JSON.stringify(settings));
                console.log("Settings saved to localStorage.");
            } catch (e) {
                console.error("Error saving settings to localStorage:", e);
                // No need for a message box here, as it might appear too often on subtle storage issues.
            }
        }

        /**
         * Loads advanced settings from localStorage.
         */
        function loadSettings() {
            try {
                const savedSettings = localStorage.getItem(SETTINGS_STORAGE_KEY);
                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);

                    // Populate customer name
                    customerNameInput.value = settings.customerName || '';

                    // Populate profit margins
                    profitSlidingGateMaterialInput.value = settings.profitSlidingGateMaterial || Math.round(DEFAULT_PROFIT_SLIDING_GATE_MATERIAL * 100);
                    profitPedestrianGateMaterialInput.value = settings.profitPedestrianGateMaterial || Math.round(DEFAULT_PROFIT_PEDESTRIAN_GATE_MATERIAL * 100);
                    profitPanelsMaterialInput.value = settings.profitPanelsMaterial || Math.round(DEFAULT_PROFIT_PANELS_MATERIAL * 100);
                    profitPostsMaterialInput.value = settings.profitPostsMaterial || Math.round(DEFAULT_PROFIT_POSTS_MATERIAL * 100);
                    profitCapsBracketsMaterialInput.value = settings.profitCapsBracketsMaterial || Math.round(DEFAULT_PROFIT_CAPS_BRACKETS_MATERIAL * 100);
                    profitPowderCoatingInput.value = settings.profitPowderCoating || Math.round(DEFAULT_PROFIT_POWDER_COATING * 100);
                    profitGateMotorsInput.value = settings.profitGateMotors || Math.round(DEFAULT_PROFIT_GATE_MOTORS * 100);
                    profitGateMotorHardwareInput.value = settings.profitGateMotorHardware || Math.round(DEFAULT_PROFIT_GATE_MOTOR_HARDWARE * 100);

                    // Populate installation costs
                    installPostsFixedInput.value = settings.installPostsFixed || DEFAULT_INSTALL_POSTS_FIXED;
                    installSlidingGateFixedInput.value = settings.installSlidingGateFixed || DEFAULT_INSTALL_SLIDING_GATE_FIXED;
                    installPedestrianGateFixedInput.value = settings.installPedestrianGateFixed || DEFAULT_INSTALL_PEDESTRIAN_GATE_FIXED;
                    installPanelsPerMeterInput.value = settings.installPanelsPerMeter || DEFAULT_INSTALL_PANELS_PER_METER;
                    installMotorFixedInput.value = settings.installMotorFixed || DEFAULT_INSTALL_MOTOR_FIXED; // Load new motor install cost

                    // Populate fabrication costs
                    fabricationCostPerDayInput.value = settings.fabricationCostPerDay || DEFAULT_FABRICATION_COST_PER_DAY;
                    fabricationDaysPerJobInput.value = settings.fabricationDaysPerJob || DEFAULT_FABRICATION_DAYS_PER_JOB;

                    // Populate dynamic material costs (ensure elements exist first)
                    // This part needs to run AFTER materialCostInputsDiv is populated
                    // This listener ensures the dynamic inputs exist before trying to set their values
                    // Note: This DOMContentLoaded listener is wrapped to ensure it only adds itself once.
                    // The `initializeAdvancedSettings` function itself ensures the inputs are present.
                    // This specific logic is best handled directly within initializeAdvancedSettings
                    // after the inputs have been created.
                    if (settings.materialCosts) {
                        for (const key in settings.materialCosts) {
                            const inputId = `material-${key.replace(/\s+/g, '-')}-cost`;
                            const inputElement = document.getElementById(inputId);
                            if (inputElement) {
                                inputElement.value = settings.materialCosts[key];
                            }
                        }
                    }
                    console.log("Settings loaded from localStorage.");
                    return true; // Settings loaded successfully
                }
            } catch (e) {
                console.error("Error loading or parsing settings from localStorage:", e);
                // Fallback to defaults if there's an error
            }
            return false; // No settings loaded
        }


        /**
         * Initializes the advanced settings input fields with default values,
         * or loads from localStorage if available.
         */
        function initializeAdvancedSettings() {
            // Dynamically create and populate material cost inputs first,
            // so loadSettings can find them.
            materialCostInputsDiv.innerHTML = ''; // Clear previous inputs
            for (const key in defaultMaterialPriceList) {
                const materialLabel = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                const inputId = `material-${key.replace(/\s+/g, '-')}-cost`;
                const currentValue = defaultMaterialPriceList[key].pricePerUnit;

                const inputHtml = `
                    <div class="input-group">
                        <label for="${inputId}">${materialLabel}:</label>
                        <div class="relative mt-1">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-500">$</span>
                            <input type="number" id="${inputId}" class="block w-full input-with-symbol-left" value="${currentValue.toFixed(2)}" min="0" step="0.01">
                        </div>
                    </div>
                `;
                materialCostInputsDiv.innerHTML += inputHtml;
            }

            // Now attempt to load saved settings. If unsuccessful, fall back to default values.
            if (!loadSettings()) {
                // Only set defaults if loadSettings() returns false (i.e., no saved settings or error)
                customerNameInput.value = ''; // Set default for customer name

                profitSlidingGateMaterialInput.value = Math.round(DEFAULT_PROFIT_SLIDING_GATE_MATERIAL * 100);
                profitPedestrianGateMaterialInput.value = Math.round(DEFAULT_PROFIT_PEDESTRIAN_GATE_MATERIAL * 100);
                profitPanelsMaterialInput.value = Math.round(DEFAULT_PROFIT_PANELS_MATERIAL * 100);
                profitPostsMaterialInput.value = Math.round(DEFAULT_PROFIT_POSTS_MATERIAL * 100);
                profitCapsBracketsMaterialInput.value = Math.round(DEFAULT_PROFIT_CAPS_BRACKETS_MATERIAL * 100);
                profitPowderCoatingInput.value = Math.round(DEFAULT_PROFIT_POWDER_COATING * 100);
                profitGateMotorsInput.value = Math.round(DEFAULT_PROFIT_GATE_MOTORS * 100);
                profitGateMotorHardwareInput.value = Math.round(DEFAULT_PROFIT_GATE_MOTOR_HARDWARE * 100);

                installPostsFixedInput.value = DEFAULT_INSTALL_POSTS_FIXED;
                installSlidingGateFixedInput.value = DEFAULT_INSTALL_SLIDING_GATE_FIXED;
                installPedestrianGateFixedInput.value = DEFAULT_INSTALL_PEDESTRIAN_GATE_FIXED;
                installPanelsPerMeterInput.value = DEFAULT_INSTALL_PANELS_PER_METER;
                installMotorFixedInput.value = DEFAULT_INSTALL_MOTOR_FIXED; // Set default for new motor install cost

                fabricationCostPerDayInput.value = DEFAULT_FABRICATION_COST_PER_DAY;
                fabricationDaysPerJobInput.value = DEFAULT_FABRICATION_DAYS_PER_JOB;

                // For dynamic material inputs, if loadSettings failed, their initial value is already the default from when they were generated.
            }

            // Add event listeners for input changes to save settings
            const advancedSettingsInputs = advancedSettingsContent.querySelectorAll('input[type="number"], select');
            advancedSettingsInputs.forEach(input => {
                input.addEventListener('input', saveSettings);
                input.addEventListener('change', saveSettings); // For select elements and checkboxes
            });
            // Also add a listener for the customer name input
            customerNameInput.addEventListener('input', saveSettings);
        }


        // Initialize visibility on load and update panel info
        document.addEventListener('DOMContentLoaded', () => {
            toggleInputs(slidingGateYes, slidingGateNo, slidingGateInputs);
            toggleInputs(pedestrianGateYes, pedestrianGateNo, pedestrianGateInputs);
            toggleInputs(gateMotorYes, gateMotorNo, motorInputs);
            updateCalculatedPostLength(); // Call once on load to set initial post length display (even if hidden, for internal value)
            updateFencePanelInfo(); // Call once on load to show initial panel info
            initializeAdvancedSettings(); // Initialize advanced settings inputs and load saved data
            loadSavedQuotes(); // Load quotes from local storage on app start
        });


        // Add event listeners for new toggle buttons for results sections
        document.querySelectorAll('#results .toggle-btn').forEach(button => {
            button.addEventListener('click', () => {
                toggleCollapsibleSection(button);
            });
        });

    </script>
</body>
</html>
